# Handleræ¶ˆæ¯æœºåˆ¶é¢è¯•é¢˜

æœ¬ç« èŠ‚åŒ…å«Android Handleræ¶ˆæ¯æœºåˆ¶çš„ç›¸å…³é¢è¯•é¢˜ï¼Œæ¶µç›–HandleråŸºæœ¬åŸç†ã€æ¶ˆæ¯é˜Ÿåˆ—ã€çº¿ç¨‹é€šä¿¡ç­‰æ ¸å¿ƒæ¦‚å¿µã€‚

## åŸºç¡€æ¦‚å¿µ

### ğŸ”¥ é€‰æ‹©é¢˜ï¼šHandleråŸºç¡€

å…³äºAndroid Handleræœºåˆ¶ï¼Œä»¥ä¸‹è¯´æ³•æ­£ç¡®çš„æ˜¯ï¼š

A. Handlerå¿…é¡»åœ¨ä¸»çº¿ç¨‹åˆ›å»ºæ‰èƒ½ä½¿ç”¨
B. ä¸€ä¸ªçº¿ç¨‹å¯ä»¥æœ‰å¤šä¸ªLooperå®ä¾‹
C. Handlerå‘é€çš„æ¶ˆæ¯åœ¨åˆ›å»ºHandlerçš„çº¿ç¨‹ä¸­å¤„ç†
D. MessageQueueé‡‡ç”¨å…ˆè¿›åå‡ºï¼ˆLIFOï¼‰çš„æ–¹å¼å¤„ç†æ¶ˆæ¯

<details>
<summary>ç­”æ¡ˆä¸è§£æ</summary>

**ç­”æ¡ˆï¼šC**

è§£æï¼š
1. Handlerå¯ä»¥åœ¨ä»»ä½•çº¿ç¨‹åˆ›å»ºï¼Œä½†åˆ›å»ºæ—¶è¯¥çº¿ç¨‹å¿…é¡»æœ‰Looper
2. ä¸€ä¸ªçº¿ç¨‹åªèƒ½æœ‰ä¸€ä¸ªLooperå®ä¾‹
3. Handlerå‘é€çš„æ¶ˆæ¯ä¼šåœ¨åˆ›å»ºHandlerçš„çº¿ç¨‹çš„Looperä¸­å¤„ç†
4. MessageQueueé‡‡ç”¨å…ˆè¿›å…ˆå‡ºï¼ˆFIFOï¼‰çš„æ–¹å¼å¤„ç†æ¶ˆæ¯
</details>

### ğŸ”¥ é—®ç­”é¢˜ï¼šHandlerå·¥ä½œåŸç†

**é—®é¢˜ï¼šè¯·è¯¦ç»†è¯´æ˜Android Handleræ¶ˆæ¯æœºåˆ¶çš„å·¥ä½œåŸç†ï¼Œä»¥åŠHandlerã€Looperã€MessageQueueä¸‰è€…ä¹‹é—´çš„å…³ç³»ã€‚**

<details>
<summary>å‚è€ƒç­”æ¡ˆ</summary>

1. **åŸºæœ¬ç»„æˆéƒ¨åˆ†ï¼š**
   - Handlerï¼šæ¶ˆæ¯çš„å‘é€å’Œå¤„ç†è€…
   - Looperï¼šæ¶ˆæ¯å¾ªç¯å™¨ï¼Œä¸æ–­ä»MessageQueueä¸­å–å‡ºæ¶ˆæ¯
   - MessageQueueï¼šæ¶ˆæ¯é˜Ÿåˆ—ï¼Œå­˜å‚¨å¾…å¤„ç†çš„æ¶ˆæ¯
   - Messageï¼šæ¶ˆæ¯å¯¹è±¡ï¼ŒåŒ…å«è¦å¤„ç†çš„ä¿¡æ¯

2. **å·¥ä½œæµç¨‹ï¼š**
   - Handlerå‘é€æ¶ˆæ¯ï¼ˆMessageï¼‰åˆ°MessageQueue
   - Looperä¸æ–­å¾ªç¯ä»MessageQueueä¸­å–å‡ºæ¶ˆæ¯
   - å°†æ¶ˆæ¯åˆ†å‘ç»™å¯¹åº”çš„Handlerå¤„ç†
   - Handleråœ¨å…¶å…³è”çš„çº¿ç¨‹ä¸­å¤„ç†æ¶ˆæ¯

3. **ä¸‰è€…å…³ç³»ï¼š**
   - ä¸€ä¸ªçº¿ç¨‹åªèƒ½æœ‰ä¸€ä¸ªLooper
   - ä¸€ä¸ªLooperåªèƒ½æœ‰ä¸€ä¸ªMessageQueue
   - ä¸€ä¸ªçº¿ç¨‹å¯ä»¥æœ‰å¤šä¸ªHandler
   - HandleræŒæœ‰Looperå’ŒMessageQueueçš„å¼•ç”¨

4. **ä¸»è¦ç‰¹ç‚¹ï¼š**
   - çº¿ç¨‹é—´é€šä¿¡çš„æ ¸å¿ƒæœºåˆ¶
   - æ¶ˆæ¯å¤„ç†çš„æœ‰åºæ€§
   - é¿å…çº¿ç¨‹åŒæ­¥é—®é¢˜
   - æ”¯æŒå»¶æ—¶æ¶ˆæ¯
</details>

### ğŸ”¥ ç¼–ç¨‹é¢˜ï¼šè‡ªå®šä¹‰Handler

**é—®é¢˜ï¼šè¯·å®ç°ä¸€ä¸ªè‡ªå®šä¹‰Handlerï¼Œå®ç°å¼‚æ­¥ä»»åŠ¡æ‰§è¡Œå’Œä¸»çº¿ç¨‹æ›´æ–°UIçš„åŠŸèƒ½ã€‚åŒæ—¶å¤„ç†Handlerå¯èƒ½å¼•èµ·çš„å†…å­˜æ³„æ¼é—®é¢˜ã€‚**

<details>
<summary>å‚è€ƒç­”æ¡ˆ</summary>

```java
public class SafeHandler extends Handler {
    private final WeakReference<Callback> mCallback;

    public SafeHandler(Callback callback) {
        mCallback = new WeakReference<>(callback);
    }

    @Override
    public void handleMessage(Message msg) {
        Callback callback = mCallback.get();
        if (callback != null) {
            callback.handleMessage(msg);
        }
    }

    public interface Callback {
        void handleMessage(Message msg);
    }
}

// ä½¿ç”¨ç¤ºä¾‹
public class MyActivity extends Activity implements SafeHandler.Callback {
    private SafeHandler mHandler;
    private static final int MSG_UPDATE_UI = 1;
    private static final int MSG_ASYNC_COMPLETE = 2;

    @Override
    protected void onCreate(Bundle savedInstanceState) {
        super.onCreate(savedInstanceState);
        mHandler = new SafeHandler(this);
        startAsyncTask();
    }

    private void startAsyncTask() {
        new Thread(new Runnable() {
            @Override
            public void run() {
                // æ¨¡æ‹Ÿè€—æ—¶æ“ä½œ
                try {
                    Thread.sleep(2000);
                    // å‘é€è¿›åº¦æ›´æ–°æ¶ˆæ¯
                    mHandler.sendEmptyMessage(MSG_UPDATE_UI);
                    
                    Thread.sleep(3000);
                    // å‘é€å®Œæˆæ¶ˆæ¯
                    mHandler.sendEmptyMessage(MSG_ASYNC_COMPLETE);
                } catch (InterruptedException e) {
                    e.printStackTrace();
                }
            }
        }).start();
    }

    @Override
    public void handleMessage(Message msg) {
        switch (msg.what) {
            case MSG_UPDATE_UI:
                updateProgressUI();
                break;
            case MSG_ASYNC_COMPLETE:
                handleTaskComplete();
                break;
        }
    }

    private void updateProgressUI() {
        // æ›´æ–°è¿›åº¦UI
    }

    private void handleTaskComplete() {
        // å¤„ç†ä»»åŠ¡å®Œæˆ
    }

    @Override
    protected void onDestroy() {
        super.onDestroy();
        // ç§»é™¤æ‰€æœ‰æ¶ˆæ¯å’Œå›è°ƒï¼Œé˜²æ­¢å†…å­˜æ³„æ¼
        if (mHandler != null) {
            mHandler.removeCallbacksAndMessages(null);
        }
    }
}
```

ä»£ç è¯´æ˜ï¼š
1. ä½¿ç”¨WeakReferenceé¿å…HandleræŒæœ‰Activityå¼•ç”¨å¯¼è‡´çš„å†…å­˜æ³„æ¼
2. å®ç°Handler.Callbackæ¥å£å¤„ç†æ¶ˆæ¯
3. åœ¨Activityé”€æ¯æ—¶æ¸…é™¤æ¶ˆæ¯é˜Ÿåˆ—
4. ä½¿ç”¨é™æ€å¸¸é‡å®šä¹‰æ¶ˆæ¯ç±»å‹
5. æä¾›å¼‚æ­¥ä»»åŠ¡æ‰§è¡Œå’ŒUIæ›´æ–°çš„å®Œæ•´ç¤ºä¾‹
6. åŒ…å«å¼‚å¸¸å¤„ç†å’Œèµ„æºæ¸…ç†
</details>

## Handleré«˜çº§ç‰¹æ€§

### ğŸ”¥ é€‰æ‹©é¢˜ï¼šHandleråŒæ­¥å±éšœ

å…³äºHandlerçš„åŒæ­¥å±éšœæœºåˆ¶ï¼Œä»¥ä¸‹è¯´æ³•æ­£ç¡®çš„æ˜¯ï¼š

A. åŒæ­¥å±éšœä¼šé˜»æ­¢æ‰€æœ‰æ¶ˆæ¯çš„åˆ†å‘
B. åŒæ­¥å±éšœåªé˜»æ­¢åŒæ­¥æ¶ˆæ¯ï¼Œä¸å½±å“å¼‚æ­¥æ¶ˆæ¯
C. æ™®é€šçš„Handlerå¯ä»¥ç›´æ¥å‘é€å¼‚æ­¥æ¶ˆæ¯
D. åŒæ­¥å±éšœä¼šè‡ªåŠ¨ç§»é™¤

<details>
<summary>ç­”æ¡ˆä¸è§£æ</summary>

**ç­”æ¡ˆï¼šB**

è§£æï¼š
1. åŒæ­¥å±éšœåªä¼šé˜»æ­¢åŒæ­¥æ¶ˆæ¯çš„åˆ†å‘ï¼Œä¸ä¼šé˜»æ­¢å¼‚æ­¥æ¶ˆæ¯
2. å¼‚æ­¥æ¶ˆæ¯å¯ä»¥çªç ´åŒæ­¥å±éšœçš„é™åˆ¶
3. å‘é€å¼‚æ­¥æ¶ˆæ¯éœ€è¦ä½¿ç”¨ç‰¹æ®Šçš„æ–¹æ³•æˆ–æ ‡è®°
4. åŒæ­¥å±éšœéœ€è¦æ‰‹åŠ¨ç§»é™¤ï¼Œå¦åˆ™ä¼šä¸€ç›´å­˜åœ¨
</details>

### ğŸ”¥ é—®ç­”é¢˜ï¼šIdleHandleræœºåˆ¶

**é—®é¢˜ï¼šè¯·è§£é‡ŠHandlerä¸­IdleHandlerçš„ä½œç”¨å’Œä½¿ç”¨åœºæ™¯ï¼Œå¹¶è¯´æ˜å…¶å®ç°åŸç†ã€‚**

<details>
<summary>å‚è€ƒç­”æ¡ˆ</summary>

1. **IdleHandlerçš„ä½œç”¨ï¼š**
   - åœ¨æ¶ˆæ¯é˜Ÿåˆ—ç©ºé—²æ—¶æ‰§è¡Œä»»åŠ¡
   - æ‰§è¡Œä¼˜å…ˆçº§è¾ƒä½çš„ä»»åŠ¡
   - ä¸å½±å“ä¸»çº¿ç¨‹çš„åŠæ—¶å“åº”

2. **ä½¿ç”¨åœºæ™¯ï¼š**
   - ç•Œé¢åˆå§‹åŒ–å®Œæˆåçš„å»¶è¿ŸåŠ è½½
   - èµ„æºé¢„åŠ è½½
   - æ•°æ®é¢„å–
   - æ¸…ç†å·¥ä½œ

3. **å®ç°åŸç†ï¼š**
```java
public class IdleHandlerExample {
    private void addIdleHandler() {
        Looper.myQueue().addIdleHandler(new MessageQueue.IdleHandler() {
            @Override
            public boolean queueIdle() {
                // æ‰§è¡Œç©ºé—²æ—¶çš„ä»»åŠ¡
                doIdleWork();
                // è¿”å›falseè¡¨ç¤ºåªæ‰§è¡Œä¸€æ¬¡
                // è¿”å›trueè¡¨ç¤ºæ¯æ¬¡é˜Ÿåˆ—ç©ºé—²æ—¶éƒ½æ‰§è¡Œ
                return false;
            }
        });
    }

    private void doIdleWork() {
        // æ‰§è¡Œä¼˜å…ˆçº§è¾ƒä½çš„ä»»åŠ¡
        // ä¾‹å¦‚ï¼šé¢„åŠ è½½æ•°æ®ã€æ¸…ç†ç¼“å­˜ç­‰
    }
}
```

4. **æ³¨æ„äº‹é¡¹ï¼š**
   - IdleHandlerä¸ä¿è¯ä¸€å®šä¼šæ‰§è¡Œ
   - æ‰§è¡Œæ—¶é—´ä¸åº”è¿‡é•¿
   - éœ€è¦è€ƒè™‘è¿”å›å€¼çš„å½±å“
   - å¯èƒ½ä¼šè¢«æ–°æ¶ˆæ¯æ‰“æ–­
</details>