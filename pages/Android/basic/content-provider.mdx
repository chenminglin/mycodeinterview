# ContentProviderç›¸å…³é¢è¯•é¢˜

æœ¬ç« èŠ‚åŒ…å«Android ContentProviderç»„ä»¶ç›¸å…³çš„é¢è¯•é¢˜ï¼Œæ¶µç›–æ•°æ®å…±äº«æœºåˆ¶ã€æƒé™æ§åˆ¶ã€CRUDæ“ä½œç­‰é‡è¦æ¦‚å¿µã€‚

## ContentProvideråŸºç¡€

### ğŸ”¥ é€‰æ‹©é¢˜1ï¼šContentProviderç‰¹æ€§

å…³äºContentProviderçš„ç‰¹æ€§ï¼Œä»¥ä¸‹è¯´æ³•æ­£ç¡®çš„æ˜¯ï¼š

A. ContentProviderçš„æ•°æ®åªèƒ½æ˜¯å…³ç³»å‹æ•°æ®åº“
B. ä¸åŒåº”ç”¨ç¨‹åºä¹‹é—´å¯ä»¥é€šè¿‡ContentProviderå…±äº«æ•°æ®
C. ContentProviderçš„queryæ–¹æ³•å¿…é¡»åœ¨ä¸»çº¿ç¨‹ä¸­è°ƒç”¨
D. ContentProviderä¸éœ€è¦åœ¨AndroidManifest.xmlä¸­æ³¨å†Œ

<details>
<summary>ç­”æ¡ˆä¸è§£æ</summary>

**ç­”æ¡ˆï¼šB**

è§£æï¼š
1. ContentProviderå¯ä»¥ç”¨äºå¤šç§æ•°æ®å­˜å‚¨æ–¹å¼ï¼ŒåŒ…æ‹¬SQLiteã€æ–‡ä»¶ã€ç½‘ç»œç­‰
2. ContentProviderçš„ä¸»è¦ä½œç”¨å°±æ˜¯å®ç°è·¨åº”ç”¨æ•°æ®å…±äº«
3. ContentProviderçš„CRUDæ“ä½œéƒ½åº”è¯¥åœ¨å·¥ä½œçº¿ç¨‹ä¸­æ‰§è¡Œ
4. ContentProviderå¿…é¡»åœ¨AndroidManifest.xmlä¸­æ³¨å†Œæ‰èƒ½ä½¿ç”¨
</details>

## ContentProvideré«˜çº§ç‰¹æ€§

### ğŸ”¥ é€‰æ‹©é¢˜2ï¼šContentProvideræ•°æ®åŒæ­¥

å…³äºContentProviderçš„æ•°æ®åŒæ­¥æœºåˆ¶ï¼Œä»¥ä¸‹è¯´æ³•æ­£ç¡®çš„æ˜¯ï¼š

A. ContentObserveråªèƒ½ç›‘å¬å•ä¸ªURIçš„æ•°æ®å˜åŒ–
B. notifyChangeæ–¹æ³•åªèƒ½åœ¨ä¸»çº¿ç¨‹ä¸­è°ƒç”¨
C. æ³¨å†ŒContentObserveråå¿…é¡»æ‰‹åŠ¨è§£é™¤æ³¨å†Œ
D. ContentProviderçš„æ•°æ®å˜åŒ–é€šçŸ¥æ˜¯åŒæ­¥çš„

<details>
<summary>ç­”æ¡ˆä¸è§£æ</summary>

**ç­”æ¡ˆï¼šC**

è§£æï¼š
1. ContentObserverå¯ä»¥ç›‘å¬å¤šä¸ªURIçš„æ•°æ®å˜åŒ–
2. notifyChangeæ–¹æ³•å¯ä»¥åœ¨ä»»ä½•çº¿ç¨‹ä¸­è°ƒç”¨
3. ä¸ºé¿å…å†…å­˜æ³„æ¼ï¼Œå¿…é¡»åœ¨ä¸éœ€è¦æ—¶è§£é™¤æ³¨å†Œ
4. æ•°æ®å˜åŒ–é€šçŸ¥æ˜¯å¼‚æ­¥çš„ï¼Œé€šè¿‡Handleræœºåˆ¶å®ç°
</details>

### ğŸ”¥ é—®ç­”é¢˜3ï¼šContentProviderçš„æ‰¹é‡æ“ä½œ

**é—®é¢˜ï¼šå¦‚ä½•åœ¨ContentProviderä¸­å®ç°é«˜æ•ˆçš„æ‰¹é‡æ“ä½œï¼Ÿè¯·è¯¦ç»†è¯´æ˜å®ç°æ–¹æ¡ˆå’Œæ³¨æ„äº‹é¡¹ã€‚**

<details>
<summary>å‚è€ƒç­”æ¡ˆ</summary>

1. **å®ç°æ–¹æ¡ˆï¼š**
   ```java
   @Override
   public ContentProviderResult[] applyBatch(ArrayList<ContentProviderOperation> operations) {
       SQLiteDatabase db = mDbHelper.getWritableDatabase();
       db.beginTransaction();
       try {
           ContentProviderResult[] results = new ContentProviderResult[operations.size()];
           for (int i = 0; i < operations.size(); i++) {
               results[i] = operations.get(i).apply(this, results, i);
           }
           db.setTransactionSuccessful();
           return results;
       } finally {
           db.endTransaction();
       }
   }
   ```

2. **æ€§èƒ½ä¼˜åŒ–ï¼š**
   - ä½¿ç”¨äº‹åŠ¡ä¿è¯åŸå­æ€§
   - æ‰¹é‡æ“ä½œå‡å°‘IPCæ¬¡æ•°
   - åˆç†ä½¿ç”¨BackReference
   - ä¼˜åŒ–æ•°æ®åº“ç´¢å¼•

3. **æ³¨æ„äº‹é¡¹ï¼š**
   - æ§åˆ¶å•æ¬¡æ‰¹é‡æ“ä½œæ•°é‡
   - å¤„ç†å¹¶å‘è®¿é—®
   - å¼‚å¸¸å›æ»šå¤„ç†
   - é¿å…ANRé£é™©
</details>

### ğŸ”¥ é—®ç­”é¢˜4ï¼šContentProviderçš„URIæƒé™

**é—®é¢˜ï¼šContentProviderå¦‚ä½•å®ç°ä¸´æ—¶URIæƒé™æˆäºˆï¼Ÿè¯·è¯¦ç»†è¯´æ˜å®ç°æ–¹å¼å’Œåº”ç”¨åœºæ™¯ã€‚**

<details>
<summary>å‚è€ƒç­”æ¡ˆ</summary>

1. **å®ç°æ–¹å¼ï¼š**
   ```java
   // æˆäºˆURIæƒé™
   Intent intent = new Intent(Intent.ACTION_VIEW);
   intent.setData(uri);
   intent.addFlags(Intent.FLAG_GRANT_READ_URI_PERMISSION);
   intent.addFlags(Intent.FLAG_GRANT_WRITE_URI_PERMISSION);
   
   // åœ¨Providerä¸­å¤„ç†
   @Override
   public void onGrantUriPermission(String name, Uri uri, int mode) {
       super.onGrantUriPermission(name, uri, mode);
       // å¤„ç†ä¸´æ—¶æƒé™æˆäºˆ
   }
   ```

2. **åº”ç”¨åœºæ™¯ï¼š**
   - æ–‡ä»¶å…±äº«
   - å›¾ç‰‡é€‰æ‹©
   - æ–‡æ¡£å¤„ç†
   - åª’ä½“æ’­æ”¾

3. **æœ€ä½³å®è·µï¼š**
   - åˆç†è®¾ç½®æƒé™èŒƒå›´
   - åŠæ—¶å›æ”¶ä¸´æ—¶æƒé™
   - éªŒè¯è°ƒç”¨æ–¹èº«ä»½
   - æ—¥å¿—è®°å½•å’Œå®¡è®¡
</details>

### ğŸ”¥ ç¼–ç¨‹é¢˜2ï¼šé«˜æ€§èƒ½ContentProvider

**é—®é¢˜ï¼šå®ç°ä¸€ä¸ªæ”¯æŒé«˜å¹¶å‘ã€æ‰¹é‡æ“ä½œçš„ContentProviderï¼Œè¦æ±‚å…·å¤‡ç¼“å­˜æœºåˆ¶å’Œæ€§èƒ½ä¼˜åŒ–ã€‚**

<details>
<summary>å‚è€ƒç­”æ¡ˆ</summary>

```java
public class HighPerformanceProvider extends ContentProvider {
    private static final int CACHE_SIZE = 1024 * 1024; // 1MBç¼“å­˜
    private LruCache<String, Object> mMemoryCache;
    private SQLiteDatabase mDb;
    
    @Override
    public boolean onCreate() {
        mMemoryCache = new LruCache<String, Object>(CACHE_SIZE) {
            @Override
            protected int sizeOf(String key, Object value) {
                // è®¡ç®—ç¼“å­˜å¯¹è±¡å¤§å°
                return getObjectSize(value);
            }
        };
        mDb = new DatabaseHelper(getContext()).getWritableDatabase();
        return true;
    }
    
    @Override
    public ContentProviderResult[] applyBatch(ArrayList<ContentProviderOperation> operations) {
        ContentProviderResult[] results = new ContentProviderResult[operations.size()];
        mDb.beginTransaction();
        try {
            for (int i = 0; i < operations.size(); i++) {
                results[i] = operations.get(i).apply(this, results, i);
                updateCache(operations.get(i));
            }
            mDb.setTransactionSuccessful();
        } finally {
            mDb.endTransaction();
        }
        return results;
    }
    
    @Override
    public Cursor query(Uri uri, String[] projection, String selection,
                       String[] selectionArgs, String sortOrder) {
        // å…ˆæŸ¥è¯¢ç¼“å­˜
        String cacheKey = generateCacheKey(uri, projection, selection,
            selectionArgs, sortOrder);
        Object cachedResult = mMemoryCache.get(cacheKey);
        if (cachedResult != null) {
            return (Cursor) cachedResult;
        }
```
</details>

### ğŸ”¥ é—®ç­”é¢˜1ï¼šContentProviderçš„ä½œç”¨

**é—®é¢˜ï¼šè¯·è¯¦ç»†è¯´æ˜ContentProviderçš„ä½œç”¨å’Œåº”ç”¨åœºæ™¯ï¼Œä»¥åŠä¸å…¶ä»–æ•°æ®å…±äº«æ–¹å¼çš„æ¯”è¾ƒã€‚**

<details>
<summary>å‚è€ƒç­”æ¡ˆ</summary>

1. **ä¸»è¦ä½œç”¨ï¼š**
   - æä¾›è·¨è¿›ç¨‹æ•°æ®å…±äº«æœºåˆ¶
   - ç»Ÿä¸€æ•°æ®è®¿é—®æ¥å£
   - æä¾›æ•°æ®è®¿é—®å®‰å…¨æ€§
   - æ”¯æŒCRUDæ“ä½œ

2. **åº”ç”¨åœºæ™¯ï¼š**
   - ç³»ç»Ÿæ•°æ®è®¿é—®ï¼ˆé€šè®¯å½•ã€æ—¥å†ç­‰ï¼‰
   - åº”ç”¨é—´æ•°æ®å…±äº«
   - å°è£…æ•°æ®è®¿é—®ç»†èŠ‚
   - æ•°æ®æºåˆ‡æ¢

3. **ä¼˜åŠ¿å¯¹æ¯”ï¼š**
   - ç›¸æ¯”Fileï¼šæä¾›ç»Ÿä¸€æ¥å£ï¼Œæ”¯æŒå¹¶å‘è®¿é—®
   - ç›¸æ¯”SharedPreferencesï¼šæ”¯æŒå¤æ‚æ•°æ®ç±»å‹ï¼Œæ”¯æŒè·¨è¿›ç¨‹
   - ç›¸æ¯”SQLiteï¼šæä¾›å®‰å…¨è®¿é—®æœºåˆ¶ï¼Œæ— éœ€å…³å¿ƒåº•å±‚å®ç°
   - ç›¸æ¯”Socketï¼šæ›´é€‚åˆæ•°æ®å…±äº«åœºæ™¯ï¼Œä½¿ç”¨æ›´ç®€å•
</details>

## ContentProvideré«˜çº§ç‰¹æ€§

### ğŸ”¥ é€‰æ‹©é¢˜2ï¼šContentProvideræ•°æ®åŒæ­¥

å…³äºContentProviderçš„æ•°æ®åŒæ­¥æœºåˆ¶ï¼Œä»¥ä¸‹è¯´æ³•æ­£ç¡®çš„æ˜¯ï¼š

A. ContentObserveråªèƒ½ç›‘å¬å•ä¸ªURIçš„æ•°æ®å˜åŒ–
B. notifyChangeæ–¹æ³•åªèƒ½åœ¨ä¸»çº¿ç¨‹ä¸­è°ƒç”¨
C. æ³¨å†ŒContentObserveråå¿…é¡»æ‰‹åŠ¨è§£é™¤æ³¨å†Œ
D. ContentProviderçš„æ•°æ®å˜åŒ–é€šçŸ¥æ˜¯åŒæ­¥çš„

<details>
<summary>ç­”æ¡ˆä¸è§£æ</summary>

**ç­”æ¡ˆï¼šC**

è§£æï¼š
1. ContentObserverå¯ä»¥ç›‘å¬å¤šä¸ªURIçš„æ•°æ®å˜åŒ–
2. notifyChangeæ–¹æ³•å¯ä»¥åœ¨ä»»ä½•çº¿ç¨‹ä¸­è°ƒç”¨
3. ä¸ºé¿å…å†…å­˜æ³„æ¼ï¼Œå¿…é¡»åœ¨ä¸éœ€è¦æ—¶è§£é™¤æ³¨å†Œ
4. æ•°æ®å˜åŒ–é€šçŸ¥æ˜¯å¼‚æ­¥çš„ï¼Œé€šè¿‡Handleræœºåˆ¶å®ç°
</details>

### ğŸ”¥ é—®ç­”é¢˜3ï¼šContentProviderçš„æ‰¹é‡æ“ä½œ

**é—®é¢˜ï¼šå¦‚ä½•åœ¨ContentProviderä¸­å®ç°é«˜æ•ˆçš„æ‰¹é‡æ“ä½œï¼Ÿè¯·è¯¦ç»†è¯´æ˜å®ç°æ–¹æ¡ˆå’Œæ³¨æ„äº‹é¡¹ã€‚**

<details>
<summary>å‚è€ƒç­”æ¡ˆ</summary>

1. **å®ç°æ–¹æ¡ˆï¼š**
   ```java
   @Override
   public ContentProviderResult[] applyBatch(ArrayList<ContentProviderOperation> operations) {
       SQLiteDatabase db = mDbHelper.getWritableDatabase();
       db.beginTransaction();
       try {
           ContentProviderResult[] results = new ContentProviderResult[operations.size()];
           for (int i = 0; i < operations.size(); i++) {
               results[i] = operations.get(i).apply(this, results, i);
           }
           db.setTransactionSuccessful();
           return results;
       } finally {
           db.endTransaction();
       }
   }
   ```

2. **æ€§èƒ½ä¼˜åŒ–ï¼š**
   - ä½¿ç”¨äº‹åŠ¡ä¿è¯åŸå­æ€§
   - æ‰¹é‡æ“ä½œå‡å°‘IPCæ¬¡æ•°
   - åˆç†ä½¿ç”¨BackReference
   - ä¼˜åŒ–æ•°æ®åº“ç´¢å¼•

3. **æ³¨æ„äº‹é¡¹ï¼š**
   - æ§åˆ¶å•æ¬¡æ‰¹é‡æ“ä½œæ•°é‡
   - å¤„ç†å¹¶å‘è®¿é—®
   - å¼‚å¸¸å›æ»šå¤„ç†
   - é¿å…ANRé£é™©
</details>

### ğŸ”¥ é—®ç­”é¢˜4ï¼šContentProviderçš„URIæƒé™

**é—®é¢˜ï¼šContentProviderå¦‚ä½•å®ç°ä¸´æ—¶URIæƒé™æˆäºˆï¼Ÿè¯·è¯¦ç»†è¯´æ˜å®ç°æ–¹å¼å’Œåº”ç”¨åœºæ™¯ã€‚**

<details>
<summary>å‚è€ƒç­”æ¡ˆ</summary>

1. **å®ç°æ–¹å¼ï¼š**
   ```java
   // æˆäºˆURIæƒé™
   Intent intent = new Intent(Intent.ACTION_VIEW);
   intent.setData(uri);
   intent.addFlags(Intent.FLAG_GRANT_READ_URI_PERMISSION);
   intent.addFlags(Intent.FLAG_GRANT_WRITE_URI_PERMISSION);
   
   // åœ¨Providerä¸­å¤„ç†
   @Override
   public void onGrantUriPermission(String name, Uri uri, int mode) {
       super.onGrantUriPermission(name, uri, mode);
       // å¤„ç†ä¸´æ—¶æƒé™æˆäºˆ
   }
   ```

2. **åº”ç”¨åœºæ™¯ï¼š**
   - æ–‡ä»¶å…±äº«
   - å›¾ç‰‡é€‰æ‹©
   - æ–‡æ¡£å¤„ç†
   - åª’ä½“æ’­æ”¾

3. **æœ€ä½³å®è·µï¼š**
   - åˆç†è®¾ç½®æƒé™èŒƒå›´
   - åŠæ—¶å›æ”¶ä¸´æ—¶æƒé™
   - éªŒè¯è°ƒç”¨æ–¹èº«ä»½
   - æ—¥å¿—è®°å½•å’Œå®¡è®¡
</details>

### ğŸ”¥ ç¼–ç¨‹é¢˜2ï¼šé«˜æ€§èƒ½ContentProvider

**é—®é¢˜ï¼šå®ç°ä¸€ä¸ªæ”¯æŒé«˜å¹¶å‘ã€æ‰¹é‡æ“ä½œçš„ContentProviderï¼Œè¦æ±‚å…·å¤‡ç¼“å­˜æœºåˆ¶å’Œæ€§èƒ½ä¼˜åŒ–ã€‚**

<details>
<summary>å‚è€ƒç­”æ¡ˆ</summary>

```java
public class HighPerformanceProvider extends ContentProvider {
    private static final int CACHE_SIZE = 1024 * 1024; // 1MBç¼“å­˜
    private LruCache<String, Object> mMemoryCache;
    private SQLiteDatabase mDb;
    
    @Override
    public boolean onCreate() {
        mMemoryCache = new LruCache<String, Object>(CACHE_SIZE) {
            @Override
            protected int sizeOf(String key, Object value) {
                // è®¡ç®—ç¼“å­˜å¯¹è±¡å¤§å°
                return getObjectSize(value);
            }
        };
        mDb = new DatabaseHelper(getContext()).getWritableDatabase();
        return true;
    }
    
    @Override
    public ContentProviderResult[] applyBatch(ArrayList<ContentProviderOperation> operations) {
        ContentProviderResult[] results = new ContentProviderResult[operations.size()];
        mDb.beginTransaction();
        try {
            for (int i = 0; i < operations.size(); i++) {
                results[i] = operations.get(i).apply(this, results, i);
                updateCache(operations.get(i));
            }
            mDb.setTransactionSuccessful();
        } finally {
            mDb.endTransaction();
        }
        return results;
    }
    
    @Override
    public Cursor query(Uri uri, String[] projection, String selection,
                       String[] selectionArgs, String sortOrder) {
        // å…ˆæŸ¥è¯¢ç¼“å­˜
        String cacheKey = generateCacheKey(uri, projection, selection,
            selectionArgs, sortOrder);
        Object cachedResult = mMemoryCache.get(cacheKey);
        if (cachedResult != null) {
            return (Cursor) cachedResult;
        }
```
</details>

### ğŸ”¥ é—®ç­”é¢˜2ï¼šContentProviderçš„å®ç°åŸç†

**é—®é¢˜ï¼šContentProviderçš„å·¥ä½œåŸç†æ˜¯ä»€ä¹ˆï¼Ÿå¦‚ä½•ä¿è¯æ•°æ®è®¿é—®çš„å®‰å…¨æ€§ï¼Ÿ**

<details>
<summary>å‚è€ƒç­”æ¡ˆ</summary>

1. **å·¥ä½œåŸç†ï¼š**
   - åŸºäºBinderæœºåˆ¶å®ç°è·¨è¿›ç¨‹é€šä¿¡
   - é€šè¿‡URIæ ‡è¯†ä¸åŒæ•°æ®é›†
   - é‡‡ç”¨CRUDç»Ÿä¸€æ¥å£è§„èŒƒ
   - æ”¯æŒæ‰¹é‡æ“ä½œå’Œäº‹åŠ¡

2. **æ•°æ®è®¿é—®æµç¨‹ï¼š**
   - åº”ç”¨é€šè¿‡ContentResolverå‘èµ·è¯·æ±‚
   - ç³»ç»Ÿé€šè¿‡URIæ‰¾åˆ°ç›®æ ‡Provider
   - Provideræ‰§è¡Œå®é™…çš„æ•°æ®æ“ä½œ
   - é€šè¿‡Binderè¿”å›ç»“æœ

3. **å®‰å…¨æœºåˆ¶ï¼š**
   - å£°æ˜æƒé™æ§åˆ¶è®¿é—®
   - URIæƒé™æ§åˆ¶
   - æ•°æ®éªŒè¯å’Œè¿‡æ»¤
   - ä¸´æ—¶æƒé™æˆäºˆ
</details>

## ContentProvideré«˜çº§ç‰¹æ€§

### ğŸ”¥ é€‰æ‹©é¢˜2ï¼šContentProvideræ•°æ®åŒæ­¥

å…³äºContentProviderçš„æ•°æ®åŒæ­¥æœºåˆ¶ï¼Œä»¥ä¸‹è¯´æ³•æ­£ç¡®çš„æ˜¯ï¼š

A. ContentObserveråªèƒ½ç›‘å¬å•ä¸ªURIçš„æ•°æ®å˜åŒ–
B. notifyChangeæ–¹æ³•åªèƒ½åœ¨ä¸»çº¿ç¨‹ä¸­è°ƒç”¨
C. æ³¨å†ŒContentObserveråå¿…é¡»æ‰‹åŠ¨è§£é™¤æ³¨å†Œ
D. ContentProviderçš„æ•°æ®å˜åŒ–é€šçŸ¥æ˜¯åŒæ­¥çš„

<details>
<summary>ç­”æ¡ˆä¸è§£æ</summary>

**ç­”æ¡ˆï¼šC**

è§£æï¼š
1. ContentObserverå¯ä»¥ç›‘å¬å¤šä¸ªURIçš„æ•°æ®å˜åŒ–
2. notifyChangeæ–¹æ³•å¯ä»¥åœ¨ä»»ä½•çº¿ç¨‹ä¸­è°ƒç”¨
3. ä¸ºé¿å…å†…å­˜æ³„æ¼ï¼Œå¿…é¡»åœ¨ä¸éœ€è¦æ—¶è§£é™¤æ³¨å†Œ
4. æ•°æ®å˜åŒ–é€šçŸ¥æ˜¯å¼‚æ­¥çš„ï¼Œé€šè¿‡Handleræœºåˆ¶å®ç°
</details>

### ğŸ”¥ é—®ç­”é¢˜3ï¼šContentProviderçš„æ‰¹é‡æ“ä½œ

**é—®é¢˜ï¼šå¦‚ä½•åœ¨ContentProviderä¸­å®ç°é«˜æ•ˆçš„æ‰¹é‡æ“ä½œï¼Ÿè¯·è¯¦ç»†è¯´æ˜å®ç°æ–¹æ¡ˆå’Œæ³¨æ„äº‹é¡¹ã€‚**

<details>
<summary>å‚è€ƒç­”æ¡ˆ</summary>

1. **å®ç°æ–¹æ¡ˆï¼š**
   ```java
   @Override
   public ContentProviderResult[] applyBatch(ArrayList<ContentProviderOperation> operations) {
       SQLiteDatabase db = mDbHelper.getWritableDatabase();
       db.beginTransaction();
       try {
           ContentProviderResult[] results = new ContentProviderResult[operations.size()];
           for (int i = 0; i < operations.size(); i++) {
               results[i] = operations.get(i).apply(this, results, i);
           }
           db.setTransactionSuccessful();
           return results;
       } finally {
           db.endTransaction();
       }
   }
   ```

2. **æ€§èƒ½ä¼˜åŒ–ï¼š**
   - ä½¿ç”¨äº‹åŠ¡ä¿è¯åŸå­æ€§
   - æ‰¹é‡æ“ä½œå‡å°‘IPCæ¬¡æ•°
   - åˆç†ä½¿ç”¨BackReference
   - ä¼˜åŒ–æ•°æ®åº“ç´¢å¼•

3. **æ³¨æ„äº‹é¡¹ï¼š**
   - æ§åˆ¶å•æ¬¡æ‰¹é‡æ“ä½œæ•°é‡
   - å¤„ç†å¹¶å‘è®¿é—®
   - å¼‚å¸¸å›æ»šå¤„ç†
   - é¿å…ANRé£é™©
</details>

### ğŸ”¥ é—®ç­”é¢˜4ï¼šContentProviderçš„URIæƒé™

**é—®é¢˜ï¼šContentProviderå¦‚ä½•å®ç°ä¸´æ—¶URIæƒé™æˆäºˆï¼Ÿè¯·è¯¦ç»†è¯´æ˜å®ç°æ–¹å¼å’Œåº”ç”¨åœºæ™¯ã€‚**

<details>
<summary>å‚è€ƒç­”æ¡ˆ</summary>

1. **å®ç°æ–¹å¼ï¼š**
   ```java
   // æˆäºˆURIæƒé™
   Intent intent = new Intent(Intent.ACTION_VIEW);
   intent.setData(uri);
   intent.addFlags(Intent.FLAG_GRANT_READ_URI_PERMISSION);
   intent.addFlags(Intent.FLAG_GRANT_WRITE_URI_PERMISSION);
   
   // åœ¨Providerä¸­å¤„ç†
   @Override
   public void onGrantUriPermission(String name, Uri uri, int mode) {
       super.onGrantUriPermission(name, uri, mode);
       // å¤„ç†ä¸´æ—¶æƒé™æˆäºˆ
   }
   ```

2. **åº”ç”¨åœºæ™¯ï¼š**
   - æ–‡ä»¶å…±äº«
   - å›¾ç‰‡é€‰æ‹©
   - æ–‡æ¡£å¤„ç†
   - åª’ä½“æ’­æ”¾

3. **æœ€ä½³å®è·µï¼š**
   - åˆç†è®¾ç½®æƒé™èŒƒå›´
   - åŠæ—¶å›æ”¶ä¸´æ—¶æƒé™
   - éªŒè¯è°ƒç”¨æ–¹èº«ä»½
   - æ—¥å¿—è®°å½•å’Œå®¡è®¡
</details>

### ğŸ”¥ ç¼–ç¨‹é¢˜2ï¼šé«˜æ€§èƒ½ContentProvider

**é—®é¢˜ï¼šå®ç°ä¸€ä¸ªæ”¯æŒé«˜å¹¶å‘ã€æ‰¹é‡æ“ä½œçš„ContentProviderï¼Œè¦æ±‚å…·å¤‡ç¼“å­˜æœºåˆ¶å’Œæ€§èƒ½ä¼˜åŒ–ã€‚**

<details>
<summary>å‚è€ƒç­”æ¡ˆ</summary>

```java
public class HighPerformanceProvider extends ContentProvider {
    private static final int CACHE_SIZE = 1024 * 1024; // 1MBç¼“å­˜
    private LruCache<String, Object> mMemoryCache;
    private SQLiteDatabase mDb;
    
    @Override
    public boolean onCreate() {
        mMemoryCache = new LruCache<String, Object>(CACHE_SIZE) {
            @Override
            protected int sizeOf(String key, Object value) {
                // è®¡ç®—ç¼“å­˜å¯¹è±¡å¤§å°
                return getObjectSize(value);
            }
        };
        mDb = new DatabaseHelper(getContext()).getWritableDatabase();
        return true;
    }
    
    @Override
    public ContentProviderResult[] applyBatch(ArrayList<ContentProviderOperation> operations) {
        ContentProviderResult[] results = new ContentProviderResult[operations.size()];
        mDb.beginTransaction();
        try {
            for (int i = 0; i < operations.size(); i++) {
                results[i] = operations.get(i).apply(this, results, i);
                updateCache(operations.get(i));
            }
            mDb.setTransactionSuccessful();
        } finally {
            mDb.endTransaction();
        }
        return results;
    }
    
    @Override
    public Cursor query(Uri uri, String[] projection, String selection,
                       String[] selectionArgs, String sortOrder) {
        // å…ˆæŸ¥è¯¢ç¼“å­˜
        String cacheKey = generateCacheKey(uri, projection, selection,
            selectionArgs, sortOrder);
        Object cachedResult = mMemoryCache.get(cacheKey);
        if (cachedResult != null) {
            return (Cursor) cachedResult;
        }
```
</details>

### ğŸ”¥ ç¼–ç¨‹é¢˜1ï¼šè‡ªå®šä¹‰ContentProvider

**é—®é¢˜ï¼šå®ç°ä¸€ä¸ªè‡ªå®šä¹‰ContentProviderï¼Œè¦æ±‚æ”¯æŒåŸºæœ¬çš„CRUDæ“ä½œï¼Œå¹¶å®ç°æƒé™æ§åˆ¶ã€‚**

<details>
<summary>å‚è€ƒç­”æ¡ˆ</summary>

```java
public class BookProvider extends ContentProvider {
    private static final String AUTHORITY = "com.example.provider.books";
    private static final String TABLE_BOOKS = "books";
    private static final int BOOKS = 1;
    private static final int BOOK_ID = 2;
    
    private static final UriMatcher sUriMatcher;
    private DatabaseHelper mDbHelper;
    
    static {
        sUriMatcher = new UriMatcher(UriMatcher.NO_MATCH);
        sUriMatcher.addURI(AUTHORITY, TABLE_BOOKS, BOOKS);
        sUriMatcher.addURI(AUTHORITY, TABLE_BOOKS + "/#", BOOK_ID);
    }
    
    @Override
    public boolean onCreate() {
        mDbHelper = new DatabaseHelper(getContext());
        return true;
    }
    
    @Override
    public Cursor query(Uri uri, String[] projection, String selection,
                       String[] selectionArgs, String sortOrder) {
        SQLiteDatabase db = mDbHelper.getReadableDatabase();
        Cursor cursor;
        
        switch (sUriMatcher.match(uri)) {
            case BOOKS:
                cursor = db.query(TABLE_BOOKS, projection, selection,
                    selectionArgs, null, null, sortOrder);
                break;
            case BOOK_ID:
                String id = uri.getLastPathSegment();
                cursor = db.query(TABLE_BOOKS, projection,
                    "_id=?", new String[]{id}, null, null, sortOrder);
                break;
            default:
                throw new IllegalArgumentException("Unknown URI: " + uri);
        }
        
        cursor.setNotificationUri(getContext().getContentResolver(), uri);
        return cursor;
    }
    
    @Override
    public Uri insert(Uri uri, ContentValues values) {
        if (sUriMatcher.match(uri) != BOOKS) {
            throw new IllegalArgumentException("Invalid URI for insert");
        }
        
        SQLiteDatabase db = mDbHelper.getWritableDatabase();
        long id = db.insert(TABLE_BOOKS, null, values);
        
        if (id > 0) {
            Uri newUri = ContentUris.withAppendedId(uri, id);
            getContext().getContentResolver().notifyChange(newUri, null);
            return newUri;
        }
        throw new SQLException("Failed to insert row into " + uri);
    }
    
    @Override
    public int update(Uri uri, ContentValues values, String selection,
                     String[] selectionArgs) {
        SQLiteDatabase db = mDbHelper.getWritableDatabase();
        int count;
        
        switch (sUriMatcher.match(uri)) {
            case BOOKS:
                count = db.update(TABLE_BOOKS, values, selection, selectionArgs);
                break;
            case BOOK_ID:
                String id = uri.getLastPathSegment();
                count = db.update(TABLE_BOOKS, values,
                    "_id=?", new String[]{id});
                break;
            default:
                throw new IllegalArgumentException("Unknown URI: " + uri);
        }
        
        getContext().getContentResolver().notifyChange(uri, null);
        return count;
    }
    
    @Override
    public int delete(Uri uri, String selection, String[] selectionArgs) {
        SQLiteDatabase db = mDbHelper.getWritableDatabase();
        int count;
        
        switch (sUriMatcher.match(uri)) {
            case BOOKS:
                count = db.delete(TABLE_BOOKS, selection, selectionArgs);
                break;
            case BOOK_ID:
                String id = uri.getLastPathSegment();
                count = db.delete(TABLE_BOOKS,
                    "_id=?", new String[]{id});
                break;
            default:
                throw new IllegalArgumentException("Unknown URI: " + uri);
        }
        
        getContext().getContentResolver().notifyChange(uri, null);
        return count;
    }
    
    @Override
    public String getType(Uri uri) {
        switch (sUriMatcher.match(uri)) {
            case BOOKS:
                return "vnd.android.cursor.dir/vnd.example.books";
            case BOOK_ID:
                return "vnd.android.cursor.item/vnd.example.books";
            default:
                throw new IllegalArgumentException("Unknown URI: " + uri);
        }
    }
}

// AndroidManifest.xmlé…ç½®
<provider
    android:name=".BookProvider"
    android:authorities="com.example.provider.books"
    android:exported="true"
    android:permission="com.example.permission.ACCESS_BOOK_PROVIDER"/>
```

ä»£ç è¯´æ˜ï¼š
1. å®ç°åŸºæœ¬çš„CRUDæ“ä½œæ¥å£
2. ä½¿ç”¨UriMatcherå¤„ç†ä¸åŒURIè¯·æ±‚
3. å®ç°æ•°æ®å˜åŒ–é€šçŸ¥æœºåˆ¶
4. æ·»åŠ æƒé™æ§åˆ¶
5. æ”¯æŒå•æ¡å’Œå¤šæ¡æ•°æ®æ“ä½œ
6. åœ¨Manifestä¸­æ­£ç¡®é…ç½®Provider
</details>

## ContentProvideré«˜çº§ç‰¹æ€§

### ğŸ”¥ é€‰æ‹©é¢˜2ï¼šContentProvideræ•°æ®åŒæ­¥

å…³äºContentProviderçš„æ•°æ®åŒæ­¥æœºåˆ¶ï¼Œä»¥ä¸‹è¯´æ³•æ­£ç¡®çš„æ˜¯ï¼š

A. ContentObserveråªèƒ½ç›‘å¬å•ä¸ªURIçš„æ•°æ®å˜åŒ–
B. notifyChangeæ–¹æ³•åªèƒ½åœ¨ä¸»çº¿ç¨‹ä¸­è°ƒç”¨
C. æ³¨å†ŒContentObserveråå¿…é¡»æ‰‹åŠ¨è§£é™¤æ³¨å†Œ
D. ContentProviderçš„æ•°æ®å˜åŒ–é€šçŸ¥æ˜¯åŒæ­¥çš„

<details>
<summary>ç­”æ¡ˆä¸è§£æ</summary>

**ç­”æ¡ˆï¼šC**

è§£æï¼š
1. ContentObserverå¯ä»¥ç›‘å¬å¤šä¸ªURIçš„æ•°æ®å˜åŒ–
2. notifyChangeæ–¹æ³•å¯ä»¥åœ¨ä»»ä½•çº¿ç¨‹ä¸­è°ƒç”¨
3. ä¸ºé¿å…å†…å­˜æ³„æ¼ï¼Œå¿…é¡»åœ¨ä¸éœ€è¦æ—¶è§£é™¤æ³¨å†Œ
4. æ•°æ®å˜åŒ–é€šçŸ¥æ˜¯å¼‚æ­¥çš„ï¼Œé€šè¿‡Handleræœºåˆ¶å®ç°
</details>

### ğŸ”¥ é—®ç­”é¢˜3ï¼šContentProviderçš„æ‰¹é‡æ“ä½œ

**é—®é¢˜ï¼šå¦‚ä½•åœ¨ContentProviderä¸­å®ç°é«˜æ•ˆçš„æ‰¹é‡æ“ä½œï¼Ÿè¯·è¯¦ç»†è¯´æ˜å®ç°æ–¹æ¡ˆå’Œæ³¨æ„äº‹é¡¹ã€‚**

<details>
<summary>å‚è€ƒç­”æ¡ˆ</summary>

1. **å®ç°æ–¹æ¡ˆï¼š**
   ```java
   @Override
   public ContentProviderResult[] applyBatch(ArrayList<ContentProviderOperation> operations) {
       SQLiteDatabase db = mDbHelper.getWritableDatabase();
       db.beginTransaction();
       try {
           ContentProviderResult[] results = new ContentProviderResult[operations.size()];
           for (int i = 0; i < operations.size(); i++) {
               results[i] = operations.get(i).apply(this, results, i);
           }
           db.setTransactionSuccessful();
           return results;
       } finally {
           db.endTransaction();
       }
   }
   ```

2. **æ€§èƒ½ä¼˜åŒ–ï¼š**
   - ä½¿ç”¨äº‹åŠ¡ä¿è¯åŸå­æ€§
   - æ‰¹é‡æ“ä½œå‡å°‘IPCæ¬¡æ•°
   - åˆç†ä½¿ç”¨BackReference
   - ä¼˜åŒ–æ•°æ®åº“ç´¢å¼•

3. **æ³¨æ„äº‹é¡¹ï¼š**
   - æ§åˆ¶å•æ¬¡æ‰¹é‡æ“ä½œæ•°é‡
   - å¤„ç†å¹¶å‘è®¿é—®
   - å¼‚å¸¸å›æ»šå¤„ç†
   - é¿å…ANRé£é™©
</details>

### ğŸ”¥ é—®ç­”é¢˜4ï¼šContentProviderçš„URIæƒé™

**é—®é¢˜ï¼šContentProviderå¦‚ä½•å®ç°ä¸´æ—¶URIæƒé™æˆäºˆï¼Ÿè¯·è¯¦ç»†è¯´æ˜å®ç°æ–¹å¼å’Œåº”ç”¨åœºæ™¯ã€‚**

<details>
<summary>å‚è€ƒç­”æ¡ˆ</summary>

1. **å®ç°æ–¹å¼ï¼š**
   ```java
   // æˆäºˆURIæƒé™
   Intent intent = new Intent(Intent.ACTION_VIEW);
   intent.setData(uri);
   intent.addFlags(Intent.FLAG_GRANT_READ_URI_PERMISSION);
   intent.addFlags(Intent.FLAG_GRANT_WRITE_URI_PERMISSION);
   
   // åœ¨Providerä¸­å¤„ç†
   @Override
   public void onGrantUriPermission(String name, Uri uri, int mode) {
       super.onGrantUriPermission(name, uri, mode);
       // å¤„ç†ä¸´æ—¶æƒé™æˆäºˆ
   }
   ```

2. **åº”ç”¨åœºæ™¯ï¼š**
   - æ–‡ä»¶å…±äº«
   - å›¾ç‰‡é€‰æ‹©
   - æ–‡æ¡£å¤„ç†
   - åª’ä½“æ’­æ”¾

3. **æœ€ä½³å®è·µï¼š**
   - åˆç†è®¾ç½®æƒé™èŒƒå›´
   - åŠæ—¶å›æ”¶ä¸´æ—¶æƒé™
   - éªŒè¯è°ƒç”¨æ–¹èº«ä»½
   - æ—¥å¿—è®°å½•å’Œå®¡è®¡
</details>

### ğŸ”¥ ç¼–ç¨‹é¢˜2ï¼šé«˜æ€§èƒ½ContentProvider

**é—®é¢˜ï¼šå®ç°ä¸€ä¸ªæ”¯æŒé«˜å¹¶å‘ã€æ‰¹é‡æ“ä½œçš„ContentProviderï¼Œè¦æ±‚å…·å¤‡ç¼“å­˜æœºåˆ¶å’Œæ€§èƒ½ä¼˜åŒ–ã€‚**

<details>
<summary>å‚è€ƒç­”æ¡ˆ</summary>

```java
public class HighPerformanceProvider extends ContentProvider {
    private static final int CACHE_SIZE = 1024 * 1024; // 1MBç¼“å­˜
    private LruCache<String, Object> mMemoryCache;
    private SQLiteDatabase mDb;
    
    @Override
    public boolean onCreate() {
        mMemoryCache = new LruCache<String, Object>(CACHE_SIZE) {
            @Override
            protected int sizeOf(String key, Object value) {
                // è®¡ç®—ç¼“å­˜å¯¹è±¡å¤§å°
                return getObjectSize(value);
            }
        };
        mDb = new DatabaseHelper(getContext()).getWritableDatabase();
        return true;
    }
    
    @Override
    public ContentProviderResult[] applyBatch(ArrayList<ContentProviderOperation> operations) {
        ContentProviderResult[] results = new ContentProviderResult[operations.size()];
        mDb.beginTransaction();
        try {
            for (int i = 0; i < operations.size(); i++) {
                results[i] = operations.get(i).apply(this, results, i);
                updateCache(operations.get(i));
            }
            mDb.setTransactionSuccessful();
        } finally {
            mDb.endTransaction();
        }
        return results;
    }
    
    @Override
    public Cursor query(Uri uri, String[] projection, String selection,
                       String[] selectionArgs, String sortOrder) {
        // å…ˆæŸ¥è¯¢ç¼“å­˜
        String cacheKey = generateCacheKey(uri, projection, selection,
            selectionArgs, sortOrder);
        Object cachedResult = mMemoryCache.get(cacheKey);
        if (cachedResult != null) {
            return (Cursor) cachedResult;
        }
```
</details>