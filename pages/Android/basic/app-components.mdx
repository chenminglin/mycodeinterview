# Androidåº”ç”¨ç¨‹åºåŸºç¡€ç»„ä»¶é¢è¯•é¢˜

æœ¬ç« èŠ‚åŒ…å«Androidåº”ç”¨ç¨‹åºåŸºæœ¬ç»„æˆéƒ¨åˆ†çš„ç›¸å…³é¢è¯•é¢˜ï¼Œæ¶µç›–å››å¤§ç»„ä»¶æ¦‚è¿°ã€åº”ç”¨ç¨‹åºå…¥å£ç‚¹ã€åº”ç”¨ç¨‹åºä¸Šä¸‹æ–‡ç­‰æ ¸å¿ƒæ¦‚å¿µã€‚

## åŸºç¡€æ¦‚å¿µ

### ğŸ”¥ é€‰æ‹©é¢˜1ï¼šAndroidå››å¤§ç»„ä»¶

å…³äºAndroidå››å¤§ç»„ä»¶ï¼Œä»¥ä¸‹è¯´æ³•æ­£ç¡®çš„æ˜¯ï¼š

A. Activityå¿…é¡»åœ¨AndroidManifest.xmlä¸­æ³¨å†Œæ‰èƒ½ä½¿ç”¨
B. Serviceå¯ä»¥ç›´æ¥é€šè¿‡newå…³é”®å­—åˆ›å»ºå®ä¾‹
C. BroadcastReceiverå¿…é¡»æ˜¯åŠ¨æ€æ³¨å†Œï¼Œä¸èƒ½é™æ€æ³¨å†Œ
D. ContentProviderä¸éœ€è¦åœ¨AndroidManifest.xmlä¸­å£°æ˜

<details>
<summary>ç­”æ¡ˆä¸è§£æ</summary>

**ç­”æ¡ˆï¼šA**

è§£æï¼š
1. Activityå¿…é¡»åœ¨AndroidManifest.xmlä¸­æ³¨å†Œï¼Œå¦åˆ™æ— æ³•ä½¿ç”¨
2. Serviceæ˜¯ç³»ç»Ÿç»„ä»¶ï¼Œä¸èƒ½ç›´æ¥newï¼Œå¿…é¡»é€šè¿‡Contextçš„startService()æˆ–bindService()æ–¹æ³•å¯åŠ¨
3. BroadcastReceiveræ—¢å¯ä»¥åŠ¨æ€æ³¨å†Œä¹Ÿå¯ä»¥åœ¨AndroidManifest.xmlä¸­é™æ€æ³¨å†Œ
4. ContentProviderå¿…é¡»åœ¨AndroidManifest.xmlä¸­å£°æ˜ï¼Œä»¥ä¾¿å…¶ä»–åº”ç”¨èƒ½å¤Ÿè®¿é—®
</details>

### ğŸ”¥ é—®ç­”é¢˜1ï¼šApplicationç±»çš„ä½œç”¨

**é—®é¢˜ï¼šè¯·è¯¦ç»†è¯´æ˜Androidä¸­Applicationç±»çš„ä½œç”¨ï¼Œä»¥åŠå¦‚ä½•æ­£ç¡®ä½¿ç”¨è‡ªå®šä¹‰Applicationç±»ã€‚**

<details>
<summary>å‚è€ƒç­”æ¡ˆ</summary>

1. **Applicationç±»çš„ä½œç”¨ï¼š**
   - ä½œä¸ºåº”ç”¨ç¨‹åºçš„å…¨å±€å…¥å£ç‚¹
   - ç»´æŠ¤åº”ç”¨çš„å…¨å±€çŠ¶æ€
   - åœ¨ç»„ä»¶åˆ›å»ºä¹‹å‰åˆå§‹åŒ–
   - å…±äº«å…¨å±€æ•°æ®å’Œèµ„æº
   - æ³¨å†Œå…¨å±€çš„ç”Ÿå‘½å‘¨æœŸå›è°ƒ

2. **ä½¿ç”¨æ–¹æ³•ï¼š**
```java
public class MyApplication extends Application {
    private static MyApplication instance;
    
    @Override
    public void onCreate() {
        super.onCreate();
        instance = this;
        // åˆå§‹åŒ–å…¨å±€èµ„æº
        initializeResources();
    }
    
    public static MyApplication getInstance() {
        return instance;
    }
    
    private void initializeResources() {
        // åˆå§‹åŒ–ç¬¬ä¸‰æ–¹åº“
        // åˆå§‹åŒ–å…¨å±€é…ç½®
        // æ³¨å†Œç”Ÿå‘½å‘¨æœŸå›è°ƒç­‰
    }
}
```

3. **åœ¨AndroidManifest.xmlä¸­æ³¨å†Œï¼š**
```xml
<application
    android:name=".MyApplication"
    android:icon="@mipmap/ic_launcher"
    android:label="@string/app_name">
    <!-- å…¶ä»–é…ç½® -->
</application>
```

4. **æ³¨æ„äº‹é¡¹ï¼š**
   - ä¸è¦åœ¨Applicationä¸­å­˜å‚¨è§†å›¾ç›¸å…³çš„æ•°æ®
   - é¿å…åœ¨onCreateä¸­è¿›è¡Œè€—æ—¶æ“ä½œ
   - ä½¿ç”¨å•ä¾‹æ¨¡å¼æ—¶æ³¨æ„å†…å­˜æ³„æ¼
   - è€ƒè™‘è¿›ç¨‹é—´æ•°æ®å…±äº«çš„é—®é¢˜
</details>

### ğŸ”¥ ç¼–ç¨‹é¢˜ï¼šContextä½¿ç”¨

**é—®é¢˜ï¼šè¯·å®ç°ä¸€ä¸ªå·¥å…·ç±»ï¼Œç”¨äºç®¡ç†å…¨å±€Contextï¼Œå¹¶è¯´æ˜ä¸åŒContextçš„ä½¿ç”¨åœºæ™¯ã€‚**

<details>
<summary>å‚è€ƒç­”æ¡ˆ</summary>

```java
public class ContextManager {
    private static Context applicationContext;
    private static WeakReference<Activity> currentActivity;

    private ContextManager() {
        // ç§æœ‰æ„é€ å‡½æ•°
    }

    public static void init(Context context) {
        if (context != null) {
            applicationContext = context.getApplicationContext();
        }
    }

    public static void setCurrentActivity(Activity activity) {
        currentActivity = new WeakReference<>(activity);
    }

    public static Context getApplicationContext() {
        if (applicationContext == null) {
            throw new IllegalStateException("Context must be initialized");
        }
        return applicationContext;
    }

    public static Activity getCurrentActivity() {
        return currentActivity != null ? currentActivity.get() : null;
    }

    // æ ¹æ®ä¸åŒåœºæ™¯é€‰æ‹©åˆé€‚çš„Context
    public static Context getProperContext(boolean preferActivity) {
        if (preferActivity) {
            Activity activity = getCurrentActivity();
            return activity != null ? activity : getApplicationContext();
        }
        return getApplicationContext();
    }

    // ç¤ºä¾‹ï¼šä¸åŒContextçš„ä½¿ç”¨åœºæ™¯
    public static void showToast(String message) {
        // UIæ“ä½œä¼˜å…ˆä½¿ç”¨Activity Context
        Context context = getProperContext(true);
        Toast.makeText(context, message, Toast.LENGTH_SHORT).show();
    }

    public static void startService(Intent intent) {
        // æœåŠ¡æ“ä½œä½¿ç”¨Application Context
        getApplicationContext().startService(intent);
    }

    public static File getCacheDir() {
        // æ–‡ä»¶æ“ä½œä½¿ç”¨Application Context
        return getApplicationContext().getCacheDir();
    }
}
```

ä»£ç è¯´æ˜ï¼š
1. ä½¿ç”¨å•ä¾‹æ¨¡å¼ç®¡ç†å…¨å±€Context
2. ä½¿ç”¨WeakReferenceé¿å…Activityå†…å­˜æ³„æ¼
3. åŒºåˆ†ä¸åŒåœºæ™¯ä¸‹Contextçš„ä½¿ç”¨ï¼š
   - Activity Contextï¼šUIç›¸å…³æ“ä½œï¼ˆDialogã€Toastç­‰ï¼‰
   - Application Contextï¼šç‹¬ç«‹äºUIçš„æ“ä½œï¼ˆServiceã€æ–‡ä»¶æ“ä½œç­‰ï¼‰
4. æä¾›å·¥å…·æ–¹æ³•ç®€åŒ–Contextçš„ä½¿ç”¨
5. åŒ…å«å¼‚å¸¸å¤„ç†å’Œç©ºå€¼æ£€æŸ¥
</details>

## Androidç³»ç»Ÿå¯åŠ¨æµç¨‹

### ğŸ”¥ é€‰æ‹©é¢˜ï¼šAndroidç³»ç»Ÿå¯åŠ¨è¿‡ç¨‹

å…³äºAndroidç³»ç»Ÿçš„å¯åŠ¨è¿‡ç¨‹ï¼Œä»¥ä¸‹è¯´æ³•æ­£ç¡®çš„æ˜¯ï¼š

A. Zygoteè¿›ç¨‹æ˜¯åœ¨System Serverè¿›ç¨‹å¯åŠ¨ä¹‹åæ‰åˆ›å»ºçš„
B. Androidç³»ç»Ÿå¯åŠ¨æ—¶ï¼Œå…ˆå¯åŠ¨Homeåº”ç”¨ï¼Œå†å¯åŠ¨ç³»ç»ŸæœåŠ¡
C. Initè¿›ç¨‹æ˜¯Androidç³»ç»Ÿçš„ç¬¬ä¸€ä¸ªè¿›ç¨‹ï¼Œè¿›ç¨‹å·ä¸º1
D. Applicationè¿›ç¨‹ä¸€å®šæ˜¯åœ¨Activityåˆ›å»ºä¹‹åæ‰å¯åŠ¨çš„

<details>
<summary>ç­”æ¡ˆä¸è§£æ</summary>

**ç­”æ¡ˆï¼šC**

è§£æï¼š
1. Initè¿›ç¨‹æ˜¯Androidç³»ç»Ÿçš„ç¬¬ä¸€ä¸ªè¿›ç¨‹ï¼ŒPIDä¸º1ï¼Œè´Ÿè´£åˆ›å»ºç³»ç»Ÿéœ€è¦çš„ç›®å½•ï¼Œå¯åŠ¨Zygoteç­‰å…³é”®è¿›ç¨‹
2. Zygoteè¿›ç¨‹æ˜¯ç”±Initè¿›ç¨‹å¯åŠ¨çš„ï¼Œå®ƒä¼šåˆ›å»ºè™šæ‹Ÿæœºå®ä¾‹ï¼Œé¢„åŠ è½½ç³»ç»Ÿèµ„æºï¼Œå¹¶forkå‡ºSystem Serverè¿›ç¨‹
3. System Serverè¿›ç¨‹è´Ÿè´£å¯åŠ¨å’Œç®¡ç†æ•´ä¸ªAndroid Frameworkä¸­çš„å„ç§Service
4. åº”ç”¨è¿›ç¨‹æ˜¯åœ¨éœ€è¦æ—¶ç”±Zygoteè¿›ç¨‹forkå‡ºæ¥çš„ï¼Œåœ¨Activityåˆ›å»ºä¹‹å‰å°±å·²ç»å¯åŠ¨
</details>

### ğŸ”¥ é—®ç­”é¢˜ï¼šè¯¦è§£Androidç³»ç»Ÿå¯åŠ¨æµç¨‹

**é—®é¢˜ï¼šè¯·è¯¦ç»†æè¿°Androidç³»ç»Ÿä»æŒ‰ä¸‹ç”µæºé”®åˆ°æ¡Œé¢æ˜¾ç¤ºçš„å®Œæ•´å¯åŠ¨æµç¨‹ã€‚**

<details>
<summary>å‚è€ƒç­”æ¡ˆ</summary>

1. **å¼•å¯¼ç¨‹åºBoot ROMå’ŒBootloaderï¼š**
   - åŠ è½½å¼•å¯¼ç¨‹åºåˆ°RAM
   - åˆå§‹åŒ–ç¡¬ä»¶è®¾å¤‡
   - å»ºç«‹å†…å­˜ç©ºé—´æ˜ å°„
   - åŠ è½½Androidç³»ç»Ÿå†…æ ¸

2. **Linuxå†…æ ¸å¯åŠ¨ï¼š**
   - åˆå§‹åŒ–å†…æ ¸
   - æŒ‚è½½æ ¹æ–‡ä»¶ç³»ç»Ÿ
   - å¯åŠ¨initè¿›ç¨‹

3. **Initè¿›ç¨‹å¯åŠ¨ï¼š**
   - åˆ›å»ºå’ŒæŒ‚è½½å¯åŠ¨æ‰€éœ€çš„æ–‡ä»¶ç›®å½•
   - è§£æinit.rcé…ç½®æ–‡ä»¶
   - å¯åŠ¨å±æ€§æœåŠ¡
   - å¯åŠ¨Zygoteè¿›ç¨‹

4. **Zygoteè¿›ç¨‹å¯åŠ¨ï¼š**
   - åˆ›å»ºJavaè™šæ‹Ÿæœº
   - é¢„åŠ è½½ç³»ç»Ÿç±»å’Œèµ„æº
   - å¯åŠ¨System Serverè¿›ç¨‹
   - ç­‰å¾…AMSè¯·æ±‚åˆ›å»ºåº”ç”¨è¿›ç¨‹

5. **System Serverè¿›ç¨‹ï¼š**
   - å¯åŠ¨Binderçº¿ç¨‹æ± 
   - åˆ›å»ºSystemServiceManager
   - å¯åŠ¨å„ç§ç³»ç»ŸæœåŠ¡ï¼ˆAMSã€WMSã€PMSç­‰ï¼‰
   - è¿›å…¥Loopå¾ªç¯ç­‰å¾…äº‹ä»¶å¤„ç†

6. **Launcherå¯åŠ¨ï¼š**
   - AMSå¯åŠ¨Launcheråº”ç”¨
   - LauncheråŠ è½½å·²å®‰è£…åº”ç”¨çš„å¿«æ·å›¾æ ‡
   - æ˜¾ç¤ºæ¡Œé¢ç•Œé¢
</details>

### ğŸ”¥ ç¼–ç¨‹é¢˜ï¼šæ¨¡æ‹Ÿç³»ç»Ÿå¯åŠ¨æµç¨‹

**é—®é¢˜ï¼šè¯·å®ç°ä¸€ä¸ªç®€å•çš„æ¡†æ¶ï¼Œæ¨¡æ‹ŸAndroidç³»ç»Ÿçš„å¯åŠ¨æµç¨‹ï¼ŒåŒ…æ‹¬è¿›ç¨‹åˆ›å»ºå’Œç³»ç»ŸæœåŠ¡å¯åŠ¨çš„æ ¸å¿ƒé€»è¾‘ã€‚**

<details>
<summary>å‚è€ƒç­”æ¡ˆ</summary>

```java
public class SystemBootSimulator {
    private static volatile SystemBootSimulator instance;
    private final List<SystemService> systemServices;
    private boolean isSystemBooted;

    private SystemBootSimulator() {
        systemServices = new ArrayList<>();
        isSystemBooted = false;
    }

    public static SystemBootSimulator getInstance() {
        if (instance == null) {
            synchronized (SystemBootSimulator.class) {
                if (instance == null) {
                    instance = new SystemBootSimulator();
                }
            }
        }
        return instance;
    }

    // æ¨¡æ‹ŸInitè¿›ç¨‹
    public void startInit() {
        System.out.println("Initè¿›ç¨‹å¯åŠ¨...PID: 1");
        createSystemDirectories();
        startZygote();
    }

    // æ¨¡æ‹ŸZygoteè¿›ç¨‹
    private void startZygote() {
        System.out.println("Zygoteè¿›ç¨‹å¯åŠ¨...");
        initJavaRuntime();
        startSystemServer();
    }

    // æ¨¡æ‹ŸSystem Serverè¿›ç¨‹
    private void startSystemServer() {
        System.out.println("System Serverè¿›ç¨‹å¯åŠ¨...");
        startSystemServices();
        startLauncher();
        isSystemBooted = true;
    }

    // å¯åŠ¨ç³»ç»ŸæœåŠ¡
    private void startSystemServices() {
        // æ·»åŠ æ ¸å¿ƒç³»ç»ŸæœåŠ¡
        addSystemService(new ActivityManagerService());
        addSystemService(new PackageManagerService());
        addSystemService(new WindowManagerService());
        
        // å¯åŠ¨æ‰€æœ‰æœåŠ¡
        for (SystemService service : systemServices) {
            service.start();
        }
    }

    private void addSystemService(SystemService service) {
        systemServices.add(service);
    }

    // æ¨¡æ‹Ÿåˆ›å»ºåº”ç”¨è¿›ç¨‹
    public void forkAppProcess(String processName) {
        if (!isSystemBooted) {
            throw new IllegalStateException("System not fully booted");
        }
        System.out.println("Fork new process: " + processName);
    }

    // è¾…åŠ©æ–¹æ³•
    private void createSystemDirectories() {
        System.out.println("åˆ›å»ºç³»ç»Ÿç›®å½•...");
    }

    private void initJavaRuntime() {
        System.out.println("åˆå§‹åŒ–Javaè¿è¡Œæ—¶...");
    }

    private void startLauncher() {
        System.out.println("å¯åŠ¨Launcher...");
        forkAppProcess("com.android.launcher");
    }

    // ç³»ç»ŸæœåŠ¡åŸºç±»
    abstract static class SystemService {
        abstract void start();
    }

    // æ¨¡æ‹ŸActivityManagerService
    static class ActivityManagerService extends SystemService {
        @Override
        void start() {
            System.out.println("ActivityManagerServiceå¯åŠ¨");
        }
    }

    // æ¨¡æ‹ŸPackageManagerService
    static class PackageManagerService extends SystemService {
        @Override
        void start() {
            System.out.println("PackageManagerServiceå¯åŠ¨");
        }
    }

    // æ¨¡æ‹ŸWindowManagerService
    static class WindowManagerService extends SystemService {
        @Override
        void start() {
            System.out.println("WindowManagerServiceå¯åŠ¨");
        }
    }

    // ä½¿ç”¨ç¤ºä¾‹
    public static void main(String[] args) {
        SystemBootSimulator simulator = SystemBootSimulator.getInstance();
        simulator.startInit();
        
        // æ¨¡æ‹Ÿå¯åŠ¨ä¸€ä¸ªåº”ç”¨
        simulator.forkAppProcess("com.example.app");
    }
}
```

ä»£ç è¯´æ˜ï¼š
1. ä½¿ç”¨å•ä¾‹æ¨¡å¼å®ç°SystemBootSimulatorï¼Œç¡®ä¿ç³»ç»Ÿå¯åŠ¨æµç¨‹åªæ‰§è¡Œä¸€æ¬¡
2. æ¨¡æ‹Ÿäº†Initã€Zygoteã€System Serverç­‰æ ¸å¿ƒè¿›ç¨‹çš„å¯åŠ¨æµç¨‹
3. å®ç°äº†ç³»ç»ŸæœåŠ¡çš„æ³¨å†Œå’Œå¯åŠ¨æœºåˆ¶
4. æä¾›äº†åº”ç”¨è¿›ç¨‹åˆ›å»ºçš„æ¨¡æ‹Ÿå®ç°
5. åŒ…å«äº†å¯åŠ¨çŠ¶æ€æ£€æŸ¥å’Œå¼‚å¸¸å¤„ç†
6. ä½¿ç”¨è§‚å¯Ÿè€…æ¨¡å¼ç®¡ç†ç³»ç»ŸæœåŠ¡
</details>