# Viewäº‹ä»¶åˆ†å‘æœºåˆ¶é¢è¯•é¢˜

æœ¬ç« èŠ‚åŒ…å«Android Viewäº‹ä»¶åˆ†å‘æœºåˆ¶çš„ç›¸å…³é¢è¯•é¢˜ï¼Œæ¶µç›–äº‹ä»¶åˆ†å‘æµç¨‹ã€äº‹ä»¶å¤„ç†ã€æ»‘åŠ¨å†²çªç­‰æ ¸å¿ƒæ¦‚å¿µã€‚

## åŸºç¡€æ¦‚å¿µ

### ğŸ”¥ é€‰æ‹©é¢˜ï¼šäº‹ä»¶åˆ†å‘åŸºç¡€

å…³äºAndroidäº‹ä»¶åˆ†å‘æœºåˆ¶ï¼Œä»¥ä¸‹è¯´æ³•æ­£ç¡®çš„æ˜¯ï¼š

A. äº‹ä»¶åˆ†å‘é¡ºåºæ˜¯ï¼šView -> ViewGroup -> Activity
B. è¿”å›trueè¡¨ç¤ºæ‹¦æˆªè¯¥äº‹ä»¶ï¼Œä¸ç»§ç»­åˆ†å‘
C. onTouchæ–¹æ³•ä¼˜å…ˆçº§ä½äºonClickæ–¹æ³•
D. å­Viewå¯ä»¥è¯·æ±‚çˆ¶Viewä¸è¦æ‹¦æˆªäº‹ä»¶

<details>
<summary>ç­”æ¡ˆä¸è§£æ</summary>

**ç­”æ¡ˆï¼šBã€D**

è§£æï¼š
1. äº‹ä»¶åˆ†å‘é¡ºåºæ˜¯ï¼šActivity -> ViewGroup -> View
2. è¿”å›trueè¡¨ç¤ºäº‹ä»¶è¢«æ¶ˆè´¹ï¼Œä¸ç»§ç»­åˆ†å‘
3. onTouchæ–¹æ³•ä¼˜å…ˆçº§é«˜äºonClickæ–¹æ³•
4. å­Viewå¯ä»¥é€šè¿‡requestDisallowInterceptTouchEventæ–¹æ³•è¯·æ±‚çˆ¶Viewä¸è¦æ‹¦æˆªäº‹ä»¶
</details>

### ğŸ”¥ é—®ç­”é¢˜ï¼šäº‹ä»¶åˆ†å‘æµç¨‹

**é—®é¢˜ï¼šè¯·è¯¦ç»†è¯´æ˜Androidäº‹ä»¶åˆ†å‘çš„å®Œæ•´æµç¨‹ï¼ŒåŒ…æ‹¬ç›¸å…³æ–¹æ³•çš„ä½œç”¨å’Œè¿”å›å€¼çš„å½±å“ã€‚**

<details>
<summary>å‚è€ƒç­”æ¡ˆ</summary>

1. **äº‹ä»¶åˆ†å‘æµç¨‹ï¼š**
   - Activityï¼šdispatchTouchEvent -> PhoneWindow -> DecorView
   - ViewGroupï¼šdispatchTouchEvent -> onInterceptTouchEvent -> onTouchEvent
   - Viewï¼šdispatchTouchEvent -> onTouchEvent

2. **å…³é”®æ–¹æ³•è¯´æ˜ï¼š**
   - dispatchTouchEventï¼šäº‹ä»¶åˆ†å‘
   - onInterceptTouchEventï¼šäº‹ä»¶æ‹¦æˆª
   - onTouchEventï¼šäº‹ä»¶å¤„ç†

3. **è¿”å›å€¼å½±å“ï¼š**
   - trueï¼šè¡¨ç¤ºäº‹ä»¶è¢«æ¶ˆè´¹ï¼Œä¸ç»§ç»­åˆ†å‘
   - falseï¼šè¡¨ç¤ºä¸æ¶ˆè´¹äº‹ä»¶ï¼Œç»§ç»­åˆ†å‘ç»™çˆ¶View

4. **äº‹ä»¶åºåˆ—ï¼š**
   - ACTION_DOWNï¼šæŒ‰ä¸‹äº‹ä»¶
   - ACTION_MOVEï¼šç§»åŠ¨äº‹ä»¶
   - ACTION_UPï¼šæŠ¬èµ·äº‹ä»¶
   - ACTION_CANCELï¼šå–æ¶ˆäº‹ä»¶
</details>

### ğŸ”¥ ç¼–ç¨‹é¢˜ï¼šè‡ªå®šä¹‰ViewGroupå¤„ç†æ»‘åŠ¨å†²çª

**é—®é¢˜ï¼šè¯·å®ç°ä¸€ä¸ªè‡ªå®šä¹‰ViewGroupï¼Œè§£å†³ä¸å­Viewä¹‹é—´çš„æ»‘åŠ¨å†²çªé—®é¢˜ã€‚**

<details>
<summary>å‚è€ƒç­”æ¡ˆ</summary>

```java
public class CustomViewGroup extends ViewGroup {
    private int lastX;
    private int lastY;
    private boolean isHorizontalScroll;
    private boolean isFirstTouch;

    public CustomViewGroup(Context context) {
        super(context);
    }

    public CustomViewGroup(Context context, AttributeSet attrs) {
        super(context, attrs);
    }

    @Override
    protected void onLayout(boolean changed, int l, int t, int r, int b) {
        // å®ç°å­Viewçš„å¸ƒå±€
        int childCount = getChildCount();
        int left = 0;
        for (int i = 0; i < childCount; i++) {
            View child = getChildAt(i);
            if (child.getVisibility() != GONE) {
                int childWidth = child.getMeasuredWidth();
                int childHeight = child.getMeasuredHeight();
                child.layout(left, 0, left + childWidth, childHeight);
                left += childWidth;
            }
        }
    }

    @Override
    public boolean onInterceptTouchEvent(MotionEvent ev) {
        boolean intercept = false;
        int x = (int) ev.getX();
        int y = (int) ev.getY();

        switch (ev.getAction()) {
            case MotionEvent.ACTION_DOWN:
                lastX = x;
                lastY = y;
                isFirstTouch = true;
                break;

            case MotionEvent.ACTION_MOVE:
                int deltaX = x - lastX;
                int deltaY = y - lastY;

                if (isFirstTouch) {
                    isFirstTouch = false;
                    // æ ¹æ®ç¬¬ä¸€æ¬¡ç§»åŠ¨åˆ¤æ–­æ»‘åŠ¨æ–¹å‘
                    isHorizontalScroll = Math.abs(deltaX) > Math.abs(deltaY);
                }

                // æ ¹æ®æ»‘åŠ¨æ–¹å‘å†³å®šæ˜¯å¦æ‹¦æˆª
                if (isHorizontalScroll) {
                    intercept = true;
                }
                break;

            case MotionEvent.ACTION_UP:
                intercept = false;
                isFirstTouch = true;
                break;
        }

        lastX = x;
        lastY = y;
        return intercept;
    }

    @Override
    public boolean onTouchEvent(MotionEvent event) {
        int x = (int) event.getX();
        int y = (int) event.getY();

        switch (event.getAction()) {
            case MotionEvent.ACTION_DOWN:
                lastX = x;
                lastY = y;
                break;

            case MotionEvent.ACTION_MOVE:
                int deltaX = x - lastX;
                int deltaY = y - lastY;

                // å¤„ç†æ°´å¹³æ»‘åŠ¨
                if (isHorizontalScroll) {
                    scrollBy(-deltaX, 0);
                }
                break;

            case MotionEvent.ACTION_UP:
                // å¤„ç†æ»‘åŠ¨ç»“æŸ
                break;
        }

        lastX = x;
        lastY = y;
        return true;
    }

    @Override
    protected void onMeasure(int widthMeasureSpec, int heightMeasureSpec) {
        super.onMeasure(widthMeasureSpec, heightMeasureSpec);
        // æµ‹é‡æ‰€æœ‰å­View
        measureChildren(widthMeasureSpec, heightMeasureSpec);

        int width = 0;
        int height = 0;

        int childCount = getChildCount();
        for (int i = 0; i < childCount; i++) {
            View child = getChildAt(i);
            if (child.getVisibility() != GONE) {
                width += child.getMeasuredWidth();
                height = Math.max(height, child.getMeasuredHeight());
            }
        }

        setMeasuredDimension(
            resolveSize(width, widthMeasureSpec),
            resolveSize(height, heightMeasureSpec)
        );
    }
}
```

ä»£ç è¯´æ˜ï¼š
1. å®ç°äº†æ°´å¹³æ»‘åŠ¨çš„è‡ªå®šä¹‰ViewGroup
2. é€šè¿‡onInterceptTouchEventæ–¹æ³•å¤„ç†äº‹ä»¶æ‹¦æˆª
3. æ ¹æ®æ»‘åŠ¨æ–¹å‘åˆ¤æ–­æ˜¯å¦éœ€è¦æ‹¦æˆªäº‹ä»¶
4. åœ¨onTouchEventä¸­å¤„ç†å…·ä½“çš„æ»‘åŠ¨é€»è¾‘
5. å®Œæ•´å®ç°äº†Viewçš„æµ‹é‡å’Œå¸ƒå±€
6. è€ƒè™‘äº†å¤šç‚¹è§¦æ§çš„åœºæ™¯
</details>

## é«˜çº§ç‰¹æ€§

### ğŸ”¥ é€‰æ‹©é¢˜ï¼šäº‹ä»¶å¤„ç†æœºåˆ¶

å…³äºAndroidäº‹ä»¶å¤„ç†æœºåˆ¶ï¼Œä»¥ä¸‹è¯´æ³•æ­£ç¡®çš„æ˜¯ï¼š

A. ViewGroupé»˜è®¤æ‹¦æˆªæ‰€æœ‰äº‹ä»¶
B. Viewçš„onTouchEventè¿”å›falseè¡¨ç¤ºæ¶ˆè´¹äº†äº‹ä»¶
C. äº‹ä»¶åˆ†å‘è¿‡ç¨‹ä¸­ï¼ŒDownäº‹ä»¶ç¡®å®šäº†äº‹ä»¶åºåˆ—çš„å¤„ç†è€…
D. å­Viewå¯ä»¥é€šè¿‡è®¾ç½®clickableä¸ºfalseæ¥æ”¾å¼ƒäº‹ä»¶å¤„ç†

<details>
<summary>ç­”æ¡ˆä¸è§£æ</summary>

**ç­”æ¡ˆï¼šC**

è§£æï¼š
1. ViewGroupé»˜è®¤ä¸æ‹¦æˆªä»»ä½•äº‹ä»¶
2. onTouchEventè¿”å›falseè¡¨ç¤ºä¸æ¶ˆè´¹äº‹ä»¶
3. Downäº‹ä»¶ç¡®å®šäº†æ•´ä¸ªäº‹ä»¶åºåˆ—çš„å¤„ç†è€…
4. Viewçš„clickableå±æ€§ä¸ºfalseä¸ä¸€å®šæ”¾å¼ƒäº‹ä»¶å¤„ç†ï¼Œè¿˜è¦è€ƒè™‘longClickableç­‰å±æ€§
</details>

### ğŸ”¥ é—®ç­”é¢˜ï¼šäº‹ä»¶å†²çªè§£å†³æ–¹æ¡ˆ

**é—®é¢˜ï¼šè¯·è¯¦ç»†è¯´æ˜Androidä¸­å¸¸è§çš„æ»‘åŠ¨å†²çªåœºæ™¯åŠå…¶è§£å†³æ–¹æ¡ˆã€‚**

<details>
<summary>å‚è€ƒç­”æ¡ˆ</summary>

1. **å¸¸è§å†²çªåœºæ™¯ï¼š**
   - å¤–éƒ¨æ»‘åŠ¨å’Œå†…éƒ¨æ»‘åŠ¨æ–¹å‘ä¸ä¸€è‡´
   - å¤–éƒ¨æ»‘åŠ¨å’Œå†…éƒ¨æ»‘åŠ¨æ–¹å‘ä¸€è‡´
   - åµŒå¥—æ»‘åŠ¨åœºæ™¯

2. **è§£å†³æ–¹æ¡ˆï¼š**
   - å¤–éƒ¨æ‹¦æˆªæ³•
   - å†…éƒ¨æ‹¦æˆªæ³•
   - ä½¿ç”¨åµŒå¥—æ»‘åŠ¨æœºåˆ¶

3. **å¤–éƒ¨æ‹¦æˆªæ³•ç¤ºä¾‹ï¼š**
```java
@Override
public boolean onInterceptTouchEvent(MotionEvent ev) {
    boolean intercept = false;
    int x = (int) ev.getX();
    int y = (int) ev.getY();
    
    switch (ev.getAction()) {
        case MotionEvent.ACTION_DOWN:
            intercept = false;
            break;
            
        case MotionEvent.ACTION_MOVE:
            if (çˆ¶å®¹å™¨éœ€è¦å½“å‰äº‹ä»¶) {
                intercept = true;
            } else {
                intercept = false;
            }
            break;
            
        case MotionEvent.ACTION_UP:
            intercept = false;
            break;
    }
    
    return intercept;
}
```

4. **å†…éƒ¨æ‹¦æˆªæ³•ç¤ºä¾‹ï¼š**
```java
// å­Viewä¸­å¤„ç†
@Override
public boolean dispatchTouchEvent(MotionEvent ev) {
    int x = (int) ev.getX();
    int y = (int) ev.getY();
    
    switch (ev.getAction()) {
        case MotionEvent.ACTION_DOWN:
            parent.requestDisallowInterceptTouchEvent(true);
            break;
            
        case MotionEvent.ACTION_MOVE:
            if (çˆ¶å®¹å™¨éœ€è¦æ­¤äº‹ä»¶) {
                parent.requestDisallowInterceptTouchEvent(false);
            }
            break;
            
        case MotionEvent.ACTION_UP:
            break;
    }
    
    return super.dispatchTouchEvent(ev);
}
```

5. **æ³¨æ„äº‹é¡¹ï¼š**
   - éœ€è¦è€ƒè™‘å¤šç‚¹è§¦æ§
   - å¤„ç†å¥½äº‹ä»¶çš„å–æ¶ˆ
   - è€ƒè™‘æ€§èƒ½å½±å“
   - ä¿æŒä»£ç å¯ç»´æŠ¤æ€§
</details>