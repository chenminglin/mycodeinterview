# Android UIå¼€å‘é¢è¯•é¢˜

æœ¬ç« èŠ‚åŒ…å«Android UIå¼€å‘ç›¸å…³çš„é«˜é¢‘é¢è¯•é¢˜ï¼Œæ¶µç›–Viewçš„ç»˜åˆ¶æµç¨‹ã€äº‹ä»¶åˆ†å‘æœºåˆ¶å’Œè‡ªå®šä¹‰Viewçš„å¼€å‘ç­‰æ ¸å¿ƒçŸ¥è¯†ç‚¹ã€‚

## Viewç»˜åˆ¶æµç¨‹

### ğŸ”¥ é—®ç­”é¢˜1ï¼šViewçš„ç»˜åˆ¶æµç¨‹

è¯·è¯¦ç»†è¯´æ˜Androidä¸­Viewçš„ç»˜åˆ¶æµç¨‹ï¼ˆmeasureã€layoutã€drawï¼‰ï¼Œä»¥åŠæ¯ä¸ªè¿‡ç¨‹çš„ä¸»è¦ä½œç”¨ã€‚

<details>
<summary>ç­”æ¡ˆä¸è§£æ</summary>

**ç­”æ¡ˆï¼š**

1. **Measureè¿‡ç¨‹**ï¼š
   - ä½œç”¨ï¼šæµ‹é‡Viewçš„å®½é«˜
   - ä¸»è¦æ–¹æ³•ï¼š
     * onMeasure()
     * measureChild()
     * measureChildren()
   - æµ‹é‡æ¨¡å¼ï¼š
     * EXACTLYï¼šç²¾ç¡®å€¼
     * AT_MOSTï¼šæœ€å¤§å€¼
     * UNSPECIFIEDï¼šä¸é™åˆ¶

2. **Layoutè¿‡ç¨‹**ï¼š
   - ä½œç”¨ï¼šç¡®å®šViewçš„ä½ç½®
   - ä¸»è¦æ–¹æ³•ï¼š
     * onLayout()
     * layout()
     * setFrame()
   - ç¡®å®šå››ä¸ªé¡¶ç‚¹çš„ä½ç½®ï¼š
     * leftã€topã€rightã€bottom

3. **Drawè¿‡ç¨‹**ï¼š
   - ä½œç”¨ï¼šå°†Viewç»˜åˆ¶åˆ°å±å¹•ä¸Š
   - ç»˜åˆ¶é¡ºåºï¼š
     1. ç»˜åˆ¶èƒŒæ™¯ drawBackground()
     2. ç»˜åˆ¶å†…å®¹ onDraw()
     3. ç»˜åˆ¶å­View dispatchDraw()
     4. ç»˜åˆ¶è£…é¥° onDrawForeground()

4. **ä»£ç ç¤ºä¾‹**ï¼š
```kotlin
class CustomView @JvmOverloads constructor(
    context: Context,
    attrs: AttributeSet? = null,
    defStyleAttr: Int = 0
) : View(context, attrs, defStyleAttr) {

    override fun onMeasure(widthMeasureSpec: Int, heightMeasureSpec: Int) {
        super.onMeasure(widthMeasureSpec, heightMeasureSpec)
        // è·å–æµ‹é‡æ¨¡å¼å’Œå¤§å°
        val widthMode = MeasureSpec.getMode(widthMeasureSpec)
        val widthSize = MeasureSpec.getSize(widthMeasureSpec)
        val heightMode = MeasureSpec.getMode(heightMeasureSpec)
        val heightSize = MeasureSpec.getSize(heightMeasureSpec)

        // è®¾ç½®æµ‹é‡åçš„å®½é«˜
        setMeasuredDimension(widthSize, heightSize)
    }

    override fun onLayout(changed: Boolean, left: Int, top: Int, right: Int, bottom: Int) {
        super.onLayout(changed, left, top, right, bottom)
        // ç¡®å®šViewçš„ä½ç½®
    }

    override fun onDraw(canvas: Canvas) {
        super.onDraw(canvas)
        // ç»˜åˆ¶Viewçš„å†…å®¹
    }
}
```

5. **æ€§èƒ½ä¼˜åŒ–å»ºè®®**ï¼š
   - é¿å…åœ¨onDrawä¸­åˆ›å»ºå¯¹è±¡
   - ä½¿ç”¨ViewStubå»¶è¿ŸåŠ è½½
   - åˆç†ä½¿ç”¨ç¡¬ä»¶åŠ é€Ÿ
   - é¿å…è¿‡åº¦ç»˜åˆ¶
</details>

## äº‹ä»¶åˆ†å‘æœºåˆ¶

### ğŸ”¥ é—®ç­”é¢˜2ï¼šäº‹ä»¶åˆ†å‘æµç¨‹

è¯·è¯¦ç»†è¯´æ˜Androidçš„äº‹ä»¶åˆ†å‘æœºåˆ¶ï¼ŒåŒ…æ‹¬äº‹ä»¶åˆ†å‘çš„æµç¨‹å’Œç›¸å…³æ–¹æ³•çš„ä½œç”¨ã€‚

<details>
<summary>ç­”æ¡ˆä¸è§£æ</summary>

**ç­”æ¡ˆï¼š**

1. **äº‹ä»¶åˆ†å‘æµç¨‹**ï¼š
   - Activity â†’ PhoneWindow â†’ DecorView â†’ ViewGroup â†’ View
   - ä¸»è¦æ–¹æ³•ï¼š
     * dispatchTouchEvent(): åˆ†å‘äº‹ä»¶
     * onInterceptTouchEvent(): æ‹¦æˆªäº‹ä»¶ï¼ˆViewGroupç‰¹æœ‰ï¼‰
     * onTouchEvent(): å¤„ç†äº‹ä»¶

2. **äº‹ä»¶åˆ†å‘è¿‡ç¨‹**ï¼š
```kotlin
// ViewGroupçš„äº‹ä»¶åˆ†å‘
override fun dispatchTouchEvent(ev: MotionEvent): Boolean {
    var handled = false
    
    // 1. åˆ¤æ–­æ˜¯å¦æ‹¦æˆª
    if (onInterceptTouchEvent(ev)) {
        // 2. è‡ªå·±å¤„ç†
        handled = onTouchEvent(ev)
    } else {
        // 3. ä¼ é€’ç»™å­View
        handled = child.dispatchTouchEvent(ev)
    }
    
    return handled
}

// Viewçš„äº‹ä»¶å¤„ç†
override fun onTouchEvent(event: MotionEvent): Boolean {
    when (event.action) {
        MotionEvent.ACTION_DOWN -> {
            // æŒ‰ä¸‹
            return true
        }
        MotionEvent.ACTION_MOVE -> {
            // ç§»åŠ¨
        }
        MotionEvent.ACTION_UP -> {
            // æŠ¬èµ·
        }
        MotionEvent.ACTION_CANCEL -> {
            // å–æ¶ˆ
        }
    }
    return super.onTouchEvent(event)
}
```

3. **äº‹ä»¶åºåˆ—**ï¼š
   - DOWN â†’ MOVE â†’ ... â†’ MOVE â†’ UP
   - æˆ– DOWN â†’ MOVE â†’ ... â†’ MOVE â†’ CANCEL

4. **è¿”å›å€¼çš„å«ä¹‰**ï¼š
   - true: äº‹ä»¶è¢«æ¶ˆè´¹ï¼Œä¸å†å¾€ä¸‹ä¼ é€’
   - false: äº‹ä»¶æœªè¢«æ¶ˆè´¹ï¼Œç»§ç»­ä¼ é€’

5. **å®é™…åº”ç”¨ç¤ºä¾‹**ï¼š
```kotlin
class CustomViewGroup : ViewGroup {
    private var lastX = 0f
    private var lastY = 0f

    override fun onInterceptTouchEvent(ev: MotionEvent): Boolean {
        when (ev.action) {
            MotionEvent.ACTION_DOWN -> {
                lastX = ev.x
                lastY = ev.y
                // ä¸æ‹¦æˆªDOWNäº‹ä»¶
                return false
            }
            MotionEvent.ACTION_MOVE -> {
                val deltaX = ev.x - lastX
                val deltaY = ev.y - lastY
                // æ ¹æ®ç§»åŠ¨è·ç¦»åˆ¤æ–­æ˜¯å¦æ‹¦æˆª
                return abs(deltaX) > abs(deltaY)
            }
        }
        return super.onInterceptTouchEvent(ev)
    }

    override fun onTouchEvent(event: MotionEvent): Boolean {
        when (event.action) {
            MotionEvent.ACTION_MOVE -> {
                // å¤„ç†æ»‘åŠ¨
                val deltaX = event.x - lastX
                scrollBy(-deltaX.toInt(), 0)
            }
        }
        lastX = event.x
        lastY = event.y
        return true
    }
}
```

6. **å¸¸è§é—®é¢˜**ï¼š
   - äº‹ä»¶å†²çªå¤„ç†
   - æ»‘åŠ¨å†²çªè§£å†³
   - å¤šç‚¹è§¦æ§å¤„ç†
</details>

## è‡ªå®šä¹‰View

### ğŸ”¥ ç¼–ç¨‹é¢˜1ï¼šè‡ªå®šä¹‰è¿›åº¦æ¡

è¯·å®ç°ä¸€ä¸ªè‡ªå®šä¹‰åœ†å½¢è¿›åº¦æ¡ï¼Œè¦æ±‚ï¼š
1. å¯ä»¥æ˜¾ç¤ºå½“å‰è¿›åº¦ç™¾åˆ†æ¯”
2. æ”¯æŒè®¾ç½®è¿›åº¦æ¡é¢œè‰²å’Œå®½åº¦
3. æœ‰åŠ¨ç”»æ•ˆæœ

<details>
<summary>ç­”æ¡ˆä¸è§£æ</summary>

**ç­”æ¡ˆï¼š**

```kotlin
class CircleProgressView @JvmOverloads constructor(
    context: Context,
    attrs: AttributeSet? = null,
    defStyleAttr: Int = 0
) : View(context, attrs, defStyleAttr) {

    private var progress = 0f
    private var maxProgress = 100f
    private var progressColor = Color.BLUE
    private var progressWidth = 10f
    private var animator: ValueAnimator? = null

    private val paint = Paint(Paint.ANTI_ALIAS_FLAG).apply {
        style = Paint.Style.STROKE
        strokeCap = Paint.Cap.ROUND
    }

    private val textPaint = Paint(Paint.ANTI_ALIAS_FLAG).apply {
        color = Color.BLACK
        textAlign = Paint.Align.CENTER
        textSize = 40f
    }

    init {
        // è·å–è‡ªå®šä¹‰å±æ€§
        val typedArray = context.obtainStyledAttributes(
            attrs,
            R.styleable.CircleProgressView
        )
        progressColor = typedArray.getColor(
            R.styleable.CircleProgressView_progressColor,
            progressColor
        )
        progressWidth = typedArray.getDimension(
            R.styleable.CircleProgressView_progressWidth,
            progressWidth
        )
        typedArray.recycle()

        // åˆå§‹åŒ–ç”»ç¬”
        paint.color = progressColor
        paint.strokeWidth = progressWidth
    }

    override fun onMeasure(widthMeasureSpec: Int, heightMeasureSpec: Int) {
        val width = MeasureSpec.getSize(widthMeasureSpec)
        val height = MeasureSpec.getSize(heightMeasureSpec)
        val size = min(width, height)
        setMeasuredDimension(size, size)
    }

    override fun onDraw(canvas: Canvas) {
        super.onDraw(canvas)

        val centerX = width / 2f
        val centerY = height / 2f
        val radius = (min(width, height) - progressWidth) / 2f

        // ç»˜åˆ¶èƒŒæ™¯åœ†ç¯
        paint.alpha = 50
        canvas.drawCircle(centerX, centerY, radius, paint)

        // ç»˜åˆ¶è¿›åº¦åœ†ç¯
        paint.alpha = 255
        val sweepAngle = progress / maxProgress * 360
        canvas.drawArc(
            progressWidth / 2,
            progressWidth / 2,
            width - progressWidth / 2,
            height - progressWidth / 2,
            -90f,
            sweepAngle,
            false,
            paint
        )

        // ç»˜åˆ¶è¿›åº¦æ–‡å­—
        val text = "${(progress / maxProgress * 100).toInt()}%"
        val textBounds = Rect()
        textPaint.getTextBounds(text, 0, text.length, textBounds)
        canvas.drawText(
            text,
            centerX,
            centerY + textBounds.height() / 2f,
            textPaint
        )
    }

    fun setProgress(progress: Float) {
        animator?.cancel()
        animator = ValueAnimator.ofFloat(this.progress, progress).apply {
            duration = 300
            interpolator = FastOutSlowInInterpolator()
            addUpdateListener { animation ->
                this@CircleProgressView.progress = animation.animatedValue as Float
                invalidate()
            }
            start()
        }
    }

    override fun onDetachedFromWindow() {
        super.onDetachedFromWindow()
        animator?.cancel()
    }
}
```

**ä½¿ç”¨æ–¹å¼**ï¼š

1. åœ¨values/attrs.xmlä¸­å®šä¹‰å±æ€§ï¼š
```xml
<?xml version="1.0" encoding="utf-8"?>
<resources>
    <declare-styleable name="CircleProgressView">
        <attr name="progressColor" format="color" />
        <attr name="progressWidth" format="dimension" />
    </declare-styleable>
</resources>
```

2. åœ¨å¸ƒå±€æ–‡ä»¶ä¸­ä½¿ç”¨ï¼š
```xml
<com.example.CircleProgressView
    android:id="@+id/circleProgress"
    android:layout_width="200dp"
    android:layout_height="200dp"
    app:progressColor="@color/colorPrimary"
    app:progressWidth="10dp" />
```

3. åœ¨ä»£ç ä¸­è®¾ç½®è¿›åº¦ï¼š
```kotlin
circleProgress.setProgress(75f)
```

**å®ç°è¦ç‚¹**ï¼š
1. ä½¿ç”¨Paintçš„ANTI_ALIAS_FLAGå¼€å¯æŠ—é”¯é½¿
2. ä½¿ç”¨ValueAnimatorå®ç°åŠ¨ç”»æ•ˆæœ
3. æ³¨æ„åœ¨Viewé”€æ¯æ—¶å–æ¶ˆåŠ¨ç”»
4. ä½¿ç”¨è‡ªå®šä¹‰å±æ€§æä¾›æ ·å¼é…ç½®
5. åˆç†å¤„ç†Viewçš„æµ‹é‡å’Œç»˜åˆ¶
</details>

### å¡«ç©ºé¢˜1ï¼šViewçš„MeasureSpec

Viewçš„MeasureSpecç”±______å’Œ______ç»„æˆï¼Œå…¶ä¸­______è¡¨ç¤ºæµ‹é‡æ¨¡å¼ï¼Œ______è¡¨ç¤ºæµ‹é‡å¤§å°ã€‚

<details>
<summary>ç­”æ¡ˆä¸è§£æ</summary>

**ç­”æ¡ˆï¼š** æµ‹é‡æ¨¡å¼ã€æµ‹é‡å¤§å°ã€é«˜2ä½ã€ä½30ä½

**è§£æï¼š**
1. MeasureSpecæ˜¯ä¸€ä¸ª32ä½çš„intå€¼ï¼š
   - é«˜2ä½è¡¨ç¤ºæµ‹é‡æ¨¡å¼ï¼ˆSpecModeï¼‰
   - ä½30ä½è¡¨ç¤ºæµ‹é‡å¤§å°ï¼ˆSpecSizeï¼‰

2. ä¸‰ç§æµ‹é‡æ¨¡å¼ï¼š
   - EXACTLYï¼ˆç²¾ç¡®æ¨¡å¼ï¼‰ï¼šmatch_parentæˆ–å…·ä½“æ•°å€¼
   - AT_MOSTï¼ˆæœ€å¤§æ¨¡å¼ï¼‰ï¼šwrap_content
   - UNSPECIFIEDï¼ˆä¸é™åˆ¶ï¼‰ï¼šScrollViewç­‰

3. ä»£ç ç¤ºä¾‹ï¼š
```kotlin
val widthMode = MeasureSpec.getMode(widthMeasureSpec)
val widthSize = MeasureSpec.getSize(widthMeasureSpec)

// åˆ›å»ºMeasureSpec
val measureSpec = MeasureSpec.makeMeasureSpec(size, mode)
```

4. æœ€ä½³å®è·µï¼š
   - è‡ªå®šä¹‰Viewæ—¶æ­£ç¡®å¤„ç†wrap_content
   - è€ƒè™‘çˆ¶Viewçš„paddingå’Œå­Viewçš„margin
   - æ³¨æ„æµ‹é‡æ¨¡å¼çš„è½¬æ¢è§„åˆ™
</details>